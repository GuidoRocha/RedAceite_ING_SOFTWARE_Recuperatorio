using BLL;
using SERVICES.Facade;
using SERVICES.DAL.Contratos;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace RedAceite_ING_SOFTWARE.Forms
{
    public partial class FrmPrincipal : Form, ILanguageObserver
    {
        // Variable para mantener referencia al formulario hijo activo actualmente
        private Form activeForm = null;

        // Timer para actualizar las estadísticas de inventario automáticamente
        private System.Windows.Forms.Timer timerActualizacion;

        public FrmPrincipal()
        {
            InitializeComponent();
            this.Tag = "Titulo_FrmPrincipal";
            
            // Suscribirse al evento Load para configurar el diseño después de que el formulario se haya cargado
            this.Load += FrmPrincipal_Load;

            // Inicializar y configurar el timer de actualización
            InicializarTimerActualizacion();

            // Suscribirse al sistema de idioma Observer
            LanguageService.Subscribe(this);
        }

        /// <summary>
        /// Evento que se ejecuta cuando el formulario se carga completamente
        /// Aquí configuramos elementos visuales que necesitan que el formulario ya esté inicializado
        /// </summary>
        private void FrmPrincipal_Load(object sender, EventArgs e)
        {
            try
            {
                // Hacer que el botón de perfil sea circular usando una región redondeada
                // Se hace aquí porque el botón ya tiene su tamaño final
                btnProfile.Region = System.Drawing.Region.FromHrgn(CreateRoundRectRgn(0, 0, btnProfile.Width, btnProfile.Height, 20, 20));
                
                // Traducir el formulario según el idioma actual
                LanguageService.TranslateForm(this);
                
                // Cargar estadísticas de inventario
                CargarEstadisticasInventario();
            }
            catch (Exception ex)
            {
                // Si hay algún error al crear el botón circular, continuar sin él
                // No es crítico para el funcionamiento de la aplicación
                System.Diagnostics.Debug.WriteLine("Error al crear botón circular: " + ex.Message);
                LoggerService.WriteException(ex);
            }
        }

        // Importación de función de Windows API para crear regiones redondeadas
        // Esto se usa para hacer el botón de perfil circular
        [System.Runtime.InteropServices.DllImport("Gdi32.dll", EntryPoint = "CreateRoundRectRgn")]
        private static extern IntPtr CreateRoundRectRgn(int nLeftRect, int nTopRect, int nRightRect, int nBottomRect, int nWidthEllipse, int nHeightEllipse);

        /// <summary>
        /// Método para abrir un formulario hijo dentro del panel principal
        /// Esto permite que los formularios se abran dentro de la ventana principal
        /// en lugar de abrir ventanas nuevas
        /// </summary>
        /// <param name="childForm">El formulario que se quiere abrir</param>
        private void OpenChildForm(Form childForm)
        {
            try
            {
                // Si hay un formulario activo, cerrarlo primero
                if (activeForm != null)
                {
                    activeForm.Close();
                    activeForm.Dispose();
                }
                
                // Configurar el nuevo formulario como hijo
                activeForm = childForm;
                childForm.TopLevel = false; // No es una ventana de nivel superior
                childForm.FormBorderStyle = FormBorderStyle.None; // Sin bordes
                childForm.Dock = DockStyle.Fill; // Llenar todo el panel
                
                // Limpiar el panel antes de agregar el nuevo formulario
                panelMain.Controls.Clear();
                
                // Agregar el formulario al panel principal
                panelMain.Controls.Add(childForm);
                panelMain.Tag = childForm;
                childForm.BringToFront(); // Traer al frente
                childForm.Show(); // Mostrar el formulario
            }
            catch (Exception ex)
            {
                // Si hay un error al abrir el formulario hijo, mostrar mensaje
                MessageBox.Show($"Error al abrir el formulario: {ex.Message}", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // ===== EVENTOS DE LOS BOTONES DEL SIDEBAR =====

        /// <summary>
        /// Evento cuando se hace clic en el botón Inicio
        /// Vuelve a mostrar el dashboard principal
        /// </summary>
        private void btnInicio_Click(object sender, EventArgs e)
        {
            VolverAInicio();
        }

        /// <summary>
        /// Evento cuando se hace clic en el logo RedAceite
        /// Vuelve a mostrar el dashboard principal
        /// </summary>
        private void lblLogo_Click(object sender, EventArgs e)
        {
            VolverAInicio();
        }

        /// <summary>
        /// Evento cuando se hace clic en el panel del logo
        /// Vuelve a mostrar el dashboard principal
        /// </summary>
        private void panelLogo_Click(object sender, EventArgs e)
        {
            VolverAInicio();
        }

        /// <summary>
        /// Método que vuelve a la vista principal (dashboard)
        /// Cierra cualquier formulario hijo abierto y muestra el dashboard
        /// </summary>
        private void VolverAInicio()
        {
            // Cerrar cualquier formulario hijo abierto
            if (activeForm != null)
            {
                activeForm.Close();
                activeForm.Dispose();
                activeForm = null;
            }

            // Limpiar el panel principal
            panelMain.Controls.Clear();

            // Volver a agregar el dashboard
            panelMain.Controls.Add(panelDashboard);
            panelDashboard.Dock = DockStyle.Fill;
            panelDashboard.BringToFront();

            // Cambiar el título
            lblTitle.Text = "Menu Principal";

            // Actualizar estadísticas al volver al dashboard
            CargarEstadisticasInventario();
        }

        /// <summary>
        /// Evento cuando se hace clic en el botón Manifiestos
        /// </summary>
        private void btnManifiestos_Click(object sender, EventArgs e)
        {
            lblTitle.Text = "Manifiestos";
            // TODO: Abrir formulario de manifiestos cuando esté disponible
            MessageBox.Show("Funcionalidad de Manifiestos próximamente", "Manifiestos", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        /// <summary>
        /// Evento cuando se hace clic en el botón Remitos
        /// Abre el formulario FrmGestionRemitos
        /// </summary>
        private void btnRemitos_Click(object sender, EventArgs e)
        {
            lblTitle.Text = "Gestión de Remitos";
            // Abrir el formulario de gestión de remitos
            try
            {
                OpenChildForm(new FrmGestionRemitos());
            }
            catch (Exception ex)
            {
                // Si hay algún error, mostrar mensaje con detalles
                MessageBox.Show($"Error al abrir Gestión de Remitos: {ex.Message}", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        /// <summary>
        /// Evento cuando se hace clic en el botón Proveedores
        /// Abre el formulario FrmGestionProveedores
        /// </summary>
        private void btnProveedores_Click(object sender, EventArgs e)
        {
            lblTitle.Text = "Proveedores";
            // Abrir el formulario de gestión de proveedores
            try
            {
                OpenChildForm(new FrmGestionProveedores());
            }
            catch (Exception ex)
            {
                // Si hay algún error, mostrar mensaje con detalles
                MessageBox.Show($"Error al abrir Proveedores: {ex.Message}", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        /// <summary>
        /// Evento cuando se hace clic en el botón Usuarios
        /// Abre el formulario FrmGestionUsuarios
        /// </summary>
        private void btnUsuarios_Click(object sender, EventArgs e)
        {
            lblTitle.Text = "Gestión de Usuarios";
            // Abrir el formulario de gestión de usuarios
            try
            {
                OpenChildForm(new FrmGestionUsuarios());
            }
            catch (Exception ex)
            {
                // Si hay algún error, mostrar mensaje con detalles
                MessageBox.Show($"Error al abrir Gestión de Usuarios: {ex.Message}", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // ===== EVENTOS DE LA BARRA SUPERIOR =====

        /// <summary>
        /// Evento cuando se hace clic en el botón de notificaciones
        /// </summary>
        private void btnNotifications_Click(object sender, EventArgs e)
        {
            MessageBox.Show("No hay notificaciones nuevas", "Notificaciones", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        /// <summary>
        /// Evento cuando se hace clic en el botón de perfil de usuario
        /// </summary>
        private void btnProfile_Click(object sender, EventArgs e)
        {
            MessageBox.Show("Configuración de perfil próximamente", "Perfil", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        // ===== EVENTOS DEL MENÚ DE IDIOMA =====

        /// <summary>
        /// Evento al seleccionar Español en el menú de idioma.
        /// </summary>
        private void menuEspañol_Click(object sender, EventArgs e)
        {
            CambiarIdioma("es-ES");
        }

        /// <summary>
        /// Evento al seleccionar English en el menú de idioma.
        /// </summary>
        private void menuIngles_Click(object sender, EventArgs e)
        {
            CambiarIdioma("en-US");
        }

        /// <summary>
        /// Cambia el idioma de la aplicación en tiempo de ejecución.
        /// </summary>
        /// <param name="languageCode">Código del idioma (es-ES o en-US).</param>
        private void CambiarIdioma(string languageCode)
        {
            try
            {
                // SetCurrentLanguage establece cultura + persiste + notifica observers
                // No es necesario traducir manualmente porque UpdateLanguage() lo hace automáticamente
                LanguageService.SetCurrentLanguage(languageCode);

                LoggerService.WriteLog(
                    $"Idioma cambiado a {languageCode} desde FrmPrincipal.",
                    System.Diagnostics.TraceLevel.Info
                );
            }
            catch (Exception ex)
            {
                LoggerService.WriteException(ex);
                MessageBox.Show(
                    $"Error al cambiar idioma: {ex.Message}",
                    "Error",
                    MessageBoxButtons.OK,
                    MessageBoxIcon.Error
                );
            }
        }

        // ===== EVENTOS DE LOS PANELES DEL DASHBOARD =====
        // Estos permiten hacer clic en los paneles informativos para navegar

        /// <summary>
        /// Evento cuando se hace clic en el panel de Remitos del dashboard
        /// Redirige al evento del botón Remitos
        /// </summary>
        private void panelRemitos_Click(object sender, EventArgs e)
        {
            btnRemitos_Click(sender, e);
        }

        /// <summary>
        /// Evento cuando se hace clic en el panel de Manifiestos del dashboard
        /// Redirige al evento del botón Manifiestos
        /// </summary>
        private void panelManifiestos_Click(object sender, EventArgs e)
        {
            btnManifiestos_Click(sender, e);
        }

        // ===== MÉTODOS PARA ESTADÍSTICAS DE INVENTARIO =====

        /// <summary>
        /// Inicializa el timer para actualizar las estadísticas de inventario automáticamente cada 5 minutos.
        /// </summary>
        private void InicializarTimerActualizacion()
        {
            try
            {
                // Crear el timer
                timerActualizacion = new System.Windows.Forms.Timer();

                // Configurar intervalo: 5 minutos = 5 * 60 * 1000 milisegundos = 300,000 ms
                timerActualizacion.Interval = 300000; // 5 minutos

                // Suscribirse al evento Tick
                timerActualizacion.Tick += TimerActualizacion_Tick;

                // Iniciar el timer
                timerActualizacion.Start();

                LoggerService.WriteLog("Timer de actualización de estadísticas iniciado (intervalo: 5 minutos).", 
                    System.Diagnostics.TraceLevel.Info);
            }
            catch (Exception ex)
            {
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Evento que se ejecuta cada vez que el timer alcanza su intervalo (cada 5 minutos).
        /// Actualiza las estadísticas de inventario automáticamente.
        /// </summary>
        private void TimerActualizacion_Tick(object sender, EventArgs e)
        {
            try
            {
                // Solo actualizar si el panel dashboard es visible (no hay formulario hijo abierto)
                if (activeForm == null && panelDashboard.Visible)
                {
                    CargarEstadisticasInventario();
                    
                    LoggerService.WriteLog("Estadísticas actualizadas automáticamente por el timer.", 
                        System.Diagnostics.TraceLevel.Info);
                }
            }
            catch (Exception ex)
            {
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Carga las estadísticas de inventario desde la base de datos y las muestra en el dashboard.
        /// </summary>
        private void CargarEstadisticasInventario()
        {
            try
            {
                var inventarioService = new InventarioService();
                var estadisticas = inventarioService.ObtenerEstadisticas();

                // Actualizar labels con los datos obtenidos
                if (lblStockAceite != null)
                    lblStockAceite.Text = $"{estadisticas.StockTotalAceite:N2} L";

                if (lblStockGrasa != null)
                    lblStockGrasa.Text = $"{estadisticas.StockTotalGrasa:N2} Kg";

                if (lblStockTotal != null)
                    lblStockTotal.Text = $"{estadisticas.StockTotal:N2} L/Kg";

                if (lblEntradasMes != null)
                    lblEntradasMes.Text = $"📥 Entradas (último mes): {estadisticas.EntradasUltimoMes}";

                if (lblSalidasMes != null)
                    lblSalidasMes.Text = $"📤 Salidas (último mes): {estadisticas.SalidasUltimoMes}";

                if (lblUltimaActualizacion != null)
                    lblUltimaActualizacion.Text = $"Última actualización: {estadisticas.FechaActualizacion:dd/MM/yyyy HH:mm}";

                LoggerService.WriteLog("Estadísticas de inventario cargadas exitosamente.", 
                    System.Diagnostics.TraceLevel.Info);
            }
            catch (Exception ex)
            {
                // Si hay error al cargar estadísticas, mostrar valores predeterminados
                if (lblStockAceite != null)
                    lblStockAceite.Text = "Error";

                if (lblStockGrasa != null)
                    lblStockGrasa.Text = "Error";

                if (lblStockTotal != null)
                    lblStockTotal.Text = "Error";

                if (lblEntradasMes != null)
                    lblEntradasMes.Text = "📥 Entradas (último mes): --";

                if (lblSalidasMes != null)
                    lblSalidasMes.Text = "📤 Salidas (último mes): --";

                if (lblUltimaActualizacion != null)
                    lblUltimaActualizacion.Text = "Error al cargar estadísticas";

                LoggerService.WriteLog($"Error al cargar estadísticas de inventario: {ex.Message}", 
                    System.Diagnostics.TraceLevel.Warning);
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Recarga las estadísticas de inventario.
        /// Útil para refrescar los datos después de operaciones que modifiquen el inventario.
        /// </summary>
        public void RefrescarEstadisticas()
        {
            CargarEstadisticasInventario();
        }

        /// <summary>
        /// Pausa la actualización automática de estadísticas.
        /// </summary>
        public void PausarActualizacionAutomatica()
        {
            if (timerActualizacion != null && timerActualizacion.Enabled)
            {
                timerActualizacion.Stop();
                LoggerService.WriteLog("Timer de actualización pausado manualmente.", 
                    System.Diagnostics.TraceLevel.Info);
            }
        }

        /// <summary>
        /// Reanuda la actualización automática de estadísticas.
        /// </summary>
        public void ReanudarActualizacionAutomatica()
        {
            if (timerActualizacion != null && !timerActualizacion.Enabled)
            {
                timerActualizacion.Start();
                LoggerService.WriteLog("Timer de actualización reanudado.", 
                    System.Diagnostics.TraceLevel.Info);
            }
        }

        // ===== IMPLEMENTACIÓN DE ILanguageObserver =====

        /// <summary>
        /// Método llamado automáticamente cuando cambia el idioma.
        /// Traduce todo el formulario y el child form activo.
        /// </summary>
        public void UpdateLanguage()
        {
            try
            {
                // Traducir este formulario
                LanguageService.TranslateForm(this);

                // Si hay un child form activo, traducirlo
                if (activeForm != null)
                {
                    LanguageService.TranslateForm(activeForm);
                }

                LoggerService.WriteLog(
                    "FrmPrincipal: Idioma actualizado vía Observer.",
                    System.Diagnostics.TraceLevel.Info
                );
            }
            catch (Exception ex)
            {
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Evento que se ejecuta al cerrar el formulario.
        /// Limpia los recursos del timer de actualización y desuscribe del Observer.
        /// </summary>
        protected override void OnFormClosing(FormClosingEventArgs e)
        {
            try
            {
                // Desuscribirse del Observer
                LanguageService.Unsubscribe(this);

                // Detener y liberar el timer
                if (timerActualizacion != null)
                {
                    timerActualizacion.Stop();
                    timerActualizacion.Tick -= TimerActualizacion_Tick;
                    timerActualizacion.Dispose();
                    timerActualizacion = null;

                    LoggerService.WriteLog("Timer de actualización detenido y recursos liberados.", 
                        System.Diagnostics.TraceLevel.Info);
                }

                LoggerService.WriteLog("FrmPrincipal cerrado y desuscrito del Observer.", 
                    System.Diagnostics.TraceLevel.Info);
            }
            catch (Exception ex)
            {
                LoggerService.WriteException(ex);
            }

            base.OnFormClosing(e);
        }
    }
}
