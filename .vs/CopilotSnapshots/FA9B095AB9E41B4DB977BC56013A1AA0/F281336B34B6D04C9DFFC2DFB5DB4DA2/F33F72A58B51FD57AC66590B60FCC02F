using SERVICES.Dominio;
using SERVICES.DAL.Contratos;
using SERVICES.Facade;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace RedAceite_ING_SOFTWARE.Forms
{
    /// <summary>
    /// Formulario para modificar los datos de un usuario existente.
    /// No permite modificar Username ni DNI.
    /// </summary>
    public partial class FrmModificarUsuario : Form, ILanguageObserver
    {
        private Guid _idUsuario;
        private Usuario _usuarioActual;

        public FrmModificarUsuario(Guid idUsuario)
        {
            InitializeComponent();
            this.Tag = "Titulo_FrmModificarUsuario";
            _idUsuario = idUsuario;

            // Suscribirse al evento Load
            this.Load += FrmModificarUsuario_Load;

            // Suscribirse al Observer de idioma
            LanguageService.Subscribe(this);

            CargarDatosUsuario();
        }

        /// <summary>
        /// Evento que se ejecuta cuando el formulario se carga.
        /// Traduce el formulario según el idioma actual.
        /// </summary>
        private void FrmModificarUsuario_Load(object sender, EventArgs e)
        {
            LanguageService.TranslateForm(this);
        }

        /// <summary>
        /// Carga los datos del usuario en el formulario.
        /// </summary>
        private void CargarDatosUsuario()
        {
            try
            {
                _usuarioActual = UserService.GetUsuarioById(_idUsuario);

                if (_usuarioActual == null)
                {
                    MessageBox.Show("No se encontró el usuario especificado.", "Error",
                        MessageBoxButtons.OK, MessageBoxIcon.Error);
                    this.Close();
                    return;
                }

                // Cargar datos en los controles
                txtUsername.Text = _usuarioActual.UserName;
                txtDNI.Text = _usuarioActual.DNI;
                txtTelefono.Text = _usuarioActual.Telefono;
                txtNombre.Text = _usuarioActual.Nombre;
                txtApellido.Text = _usuarioActual.Apellido;
                txtEmail.Text = _usuarioActual.Email;

                // Bloquear campos que no se pueden modificar
                txtUsername.ReadOnly = true;
                txtUsername.BackColor = Color.LightGray;
                txtDNI.ReadOnly = true;
                txtDNI.BackColor = Color.LightGray;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al cargar datos del usuario: {ex.Message}", "Error",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
                LoggerService.WriteException(ex);
                this.Close();
            }
        }

        /// <summary>
        /// Maneja el evento de clic del botón Guardar.
        /// </summary>
        private void btnGuardar_Click(object sender, EventArgs e)
        {
            try
            {
                // Validar campos obligatorios
                if (string.IsNullOrWhiteSpace(txtTelefono.Text) ||
                    string.IsNullOrWhiteSpace(txtNombre.Text) ||
                    string.IsNullOrWhiteSpace(txtApellido.Text) ||
                    string.IsNullOrWhiteSpace(txtEmail.Text))
                {
                    MessageBox.Show("Todos los campos marcados son obligatorios.", "Advertencia",
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                // Actualizar objeto usuario con los nuevos datos
                _usuarioActual.Telefono = txtTelefono.Text.Trim();
                _usuarioActual.Nombre = txtNombre.Text.Trim();
                _usuarioActual.Apellido = txtApellido.Text.Trim();
                _usuarioActual.Email = txtEmail.Text.Trim();

                // Guardar cambios
                UserService.UpdateUsuario(_usuarioActual);

                // Registrar en log
                LoggerService.WriteLog(
                    $"Usuario modificado: {_usuarioActual.UserName} - {_usuarioActual.Nombre} {_usuarioActual.Apellido}",
                    System.Diagnostics.TraceLevel.Info
                );

                MessageBox.Show("Usuario modificado exitosamente.", "Éxito",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);

                this.DialogResult = DialogResult.OK;
                this.Close();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al modificar usuario: {ex.Message}", "Error",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Maneja el evento de clic del botón Cancelar.
        /// </summary>
        private void btnCancelar_Click(object sender, EventArgs e)
        {
            this.DialogResult = DialogResult.Cancel;
            this.Close();
        }

        /// <summary>
        /// Maneja el evento de clic del botón Cambiar Contraseña.
        /// </summary>
        private void btnCambiarPassword_Click(object sender, EventArgs e)
        {
            try
            {
                // Validar que se haya ingresado una nueva contraseña
                if (string.IsNullOrWhiteSpace(txtNuevaPassword.Text))
                {
                    MessageBox.Show("Debe ingresar una nueva contraseña.", "Advertencia",
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                // Validar que las contraseñas coincidan
                if (txtNuevaPassword.Text != txtConfirmarPassword.Text)
                {
                    MessageBox.Show("Las contraseñas no coinciden.", "Advertencia",
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                // Cambiar la contraseña
                UserService.ChangePassword(_usuarioActual.UserName, txtNuevaPassword.Text);

                // Limpiar campos de contraseña
                txtNuevaPassword.Clear();
                txtConfirmarPassword.Clear();

                // Registrar en log
                LoggerService.WriteLog(
                    $"Contraseña cambiada para el usuario: {_usuarioActual.UserName}",
                    System.Diagnostics.TraceLevel.Warning
                );

                MessageBox.Show("Contraseña cambiada exitosamente.", "Éxito",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al cambiar contraseña: {ex.Message}", "Error",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
                LoggerService.WriteException(ex);
            }
        }

        // Implementación de ILanguageObserver

        /// <summary>
        /// Método llamado automáticamente cuando cambia el idioma.
        /// Traduce el formulario.
        /// </summary>
        public void UpdateLanguage()
        {
            try
            {
                LanguageService.TranslateForm(this);
            }
            catch (Exception ex)
            {
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Evento que se ejecuta al cerrar el formulario.
        /// Desuscribe del Observer para evitar memory leaks.
        /// </summary>
        protected override void OnFormClosing(FormClosingEventArgs e)
        {
            LanguageService.Unsubscribe(this);
            base.OnFormClosing(e);
        }
    }
}
