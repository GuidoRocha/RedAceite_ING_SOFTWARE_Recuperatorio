using SERVICES.Dominio;
using SERVICES.DAL.Contratos;
using SERVICES.Facade;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace RedAceite_ING_SOFTWARE.Forms
{
    /// <summary>
    /// Formulario principal para la gestión de usuarios.
    /// Permite listar, filtrar y gestionar usuarios (alta, baja, modificación y asignación de permisos).
    /// </summary>
    public partial class FrmGestionUsuarios : Form, ILanguageObserver
    {
        public FrmGestionUsuarios()
        {
            InitializeComponent();

            // Suscribirse a los eventos del DataGridView
            dgvUsuarios.CellFormatting += dgvUsuarios_CellFormatting;
            dgvUsuarios.DataBindingComplete += dgvUsuarios_DataBindingComplete;
            dgvUsuarios.SelectionChanged += dgvUsuarios_SelectionChanged;

            // Configurar el estado inicial de los botones (deshabilitados hasta seleccionar un usuario)
            ConfigurarEstadoBotones();

            // Cargar usuarios al final, después de suscribirse a los eventos
            CargarUsuarios();

            // Suscribirse al Observer de idioma
            LanguageService.Subscribe(this);
        }

        /// <summary>
        /// Carga todos los usuarios (activos e inactivos) en el DataGridView.
        /// </summary>
        private void CargarUsuarios()
        {
            try
            {
                // Obtener TODOS los usuarios (activos e inactivos)
                var usuarios = UserService.GetAllUsuarios();

                // Asignar el DataSource - esto disparará automáticamente el evento DataBindingComplete
                dgvUsuarios.DataSource = usuarios;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al cargar usuarios: {ex.Message}", "Error",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Evento que se dispara cuando el DataGridView ha terminado de enlazar los datos.
        /// Este es el momento correcto para configurar las columnas, ya que están completamente generadas.
        /// </summary>
        private void dgvUsuarios_DataBindingComplete(object sender, DataGridViewBindingCompleteEventArgs e)
        {
            // Configurar columnas DESPUÉS de que el grid haya terminado de cargar los datos
            ConfigurarColumnas();
        }

        /// <summary>
        /// Evento que se dispara al formatear cada celda del DataGridView.
        /// Pinta las filas de usuarios inactivos en gris oscuro.
        /// </summary>
        private void dgvUsuarios_CellFormatting(object sender, DataGridViewCellFormattingEventArgs e)
        {
            try
            {
                if (e.RowIndex >= 0 && e.RowIndex < dgvUsuarios.Rows.Count)
                {
                    var row = dgvUsuarios.Rows[e.RowIndex];
                    var usuario = row.DataBoundItem as Usuario;

                    if (usuario != null)
                    {
                        // Si el usuario NO está activo (Estado = "0"), pintar la fila en gris
                        if (usuario.Estado == "0")
                        {
                            // Pintar la fila completa en gris oscuro para usuarios inactivos
                            e.CellStyle.BackColor = Color.LightGray;
                            e.CellStyle.ForeColor = Color.DarkGray;
                            e.CellStyle.SelectionBackColor = Color.Gray;
                            e.CellStyle.SelectionForeColor = Color.White;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                // Evitar que errores en el formateo afecten el funcionamiento general
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Evento que se dispara cuando cambia la selección en el DataGridView.
        /// Habilita o deshabilita botones según el estado del usuario seleccionado.
        /// </summary>
        private void dgvUsuarios_SelectionChanged(object sender, EventArgs e)
        {
            ConfigurarEstadoBotones();
        }

        /// <summary>
        /// Configura el estado (habilitado/deshabilitado) de los botones
        /// según si hay un usuario seleccionado y su estado (activo/inactivo).
        /// </summary>
        private void ConfigurarEstadoBotones()
        {
            // Verificar si hay una fila seleccionada
            if (dgvUsuarios.SelectedRows.Count > 0)
            {
                // Obtener el usuario seleccionado
                var usuarioSeleccionado = dgvUsuarios.SelectedRows[0].DataBoundItem as Usuario;

                if (usuarioSeleccionado != null)
                {
                    // Si el usuario está ACTIVO (Estado = "1"):
                    if (usuarioSeleccionado.Estado == "1")
                    {
                        btnModificarUsuario.Enabled = true;
                        btnDeshabilitarUsuario.Enabled = true;
                        btnHabilitarUsuario.Enabled = false;
                        btnAsignarFamilias.Enabled = true;
                        btnAsignarPatentes.Enabled = true;
                    }
                    // Si el usuario está INACTIVO (Estado = "0"):
                    else
                    {
                        btnModificarUsuario.Enabled = false;
                        btnDeshabilitarUsuario.Enabled = false;
                        btnHabilitarUsuario.Enabled = true;
                        btnAsignarFamilias.Enabled = false;
                        btnAsignarPatentes.Enabled = false;
                    }
                }
            }
            else
            {
                // Si NO hay ningún usuario seleccionado, deshabilitar todos los botones de acción
                btnModificarUsuario.Enabled = false;
                btnDeshabilitarUsuario.Enabled = false;
                btnHabilitarUsuario.Enabled = false;
                btnAsignarFamilias.Enabled = false;
                btnAsignarPatentes.Enabled = false;
            }
        }

        /// <summary>
        /// Configura las columnas del DataGridView.
        /// IMPORTANTE: Este método solo debe llamarse desde el evento DataBindingComplete
        /// para asegurar que las columnas ya estén generadas.
        /// </summary>
        private void ConfigurarColumnas()
        {
            // Verificar que haya columnas para configurar
            if (dgvUsuarios.Columns.Count == 0) return;

            try
            {
                // Ocultar columnas que no se deben mostrar
                if (dgvUsuarios.Columns.Contains("IdUsuario"))
                    dgvUsuarios.Columns["IdUsuario"].Visible = false;
                if (dgvUsuarios.Columns.Contains("Password"))
                    dgvUsuarios.Columns["Password"].Visible = false;
                if (dgvUsuarios.Columns.Contains("OTP"))
                    dgvUsuarios.Columns["OTP"].Visible = false;
                if (dgvUsuarios.Columns.Contains("OTPExpiry"))
                    dgvUsuarios.Columns["OTPExpiry"].Visible = false;
                if (dgvUsuarios.Columns.Contains("Accesos"))
                    dgvUsuarios.Columns["Accesos"].Visible = false;
                if (dgvUsuarios.Columns.Contains("PhoneNumber"))
                    dgvUsuarios.Columns["PhoneNumber"].Visible = false;

                // Ocultar la columna Estado - los usuarios inactivos se identificarán por el color gris de la fila
                if (dgvUsuarios.Columns.Contains("Estado"))
                    dgvUsuarios.Columns["Estado"].Visible = false;

                // Configurar orden y encabezados
                int displayIndex = 0;

                if (dgvUsuarios.Columns.Contains("UserName"))
                {
                    dgvUsuarios.Columns["UserName"].HeaderText = "Usuario";
                    dgvUsuarios.Columns["UserName"].DisplayIndex = displayIndex++;
                    dgvUsuarios.Columns["UserName"].Width = 120;
                }

                if (dgvUsuarios.Columns.Contains("Nombre"))
                {
                    dgvUsuarios.Columns["Nombre"].HeaderText = "Nombre";
                    dgvUsuarios.Columns["Nombre"].DisplayIndex = displayIndex++;
                    dgvUsuarios.Columns["Nombre"].Width = 120;
                }

                if (dgvUsuarios.Columns.Contains("Apellido"))
                {
                    dgvUsuarios.Columns["Apellido"].HeaderText = "Apellido";
                    dgvUsuarios.Columns["Apellido"].DisplayIndex = displayIndex++;
                    dgvUsuarios.Columns["Apellido"].Width = 120;
                }

                if (dgvUsuarios.Columns.Contains("DNI"))
                {
                    dgvUsuarios.Columns["DNI"].HeaderText = "DNI";
                    dgvUsuarios.Columns["DNI"].DisplayIndex = displayIndex++;
                    dgvUsuarios.Columns["DNI"].Width = 100;
                }

                if (dgvUsuarios.Columns.Contains("Email"))
                {
                    dgvUsuarios.Columns["Email"].HeaderText = "Email";
                    dgvUsuarios.Columns["Email"].DisplayIndex = displayIndex++;
                    dgvUsuarios.Columns["Email"].Width = 180;
                }

                if (dgvUsuarios.Columns.Contains("Telefono"))
                {
                    dgvUsuarios.Columns["Telefono"].HeaderText = "Teléfono";
                    dgvUsuarios.Columns["Telefono"].DisplayIndex = displayIndex++;
                    dgvUsuarios.Columns["Telefono"].Width = 120;
                }
            }
            catch (Exception ex)
            {
                // Registrar el error pero no mostrar mensaje al usuario
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Maneja el evento de clic del botón Agregar Usuario.
        /// </summary>
        private void btnAgregarUsuario_Click(object sender, EventArgs e)
        {
            try
            {
                var frmAlta = new FrmCrearUsuario();
                frmAlta.ShowDialog();
                
                // Recargar la lista después de crear
                CargarUsuarios();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al abrir formulario de alta: {ex.Message}", "Error",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Maneja el evento de clic del botón Modificar Usuario.
        /// Solo permite modificar usuarios que estén activos.
        /// </summary>
        private void btnModificarUsuario_Click(object sender, EventArgs e)
        {
            try
            {
                if (dgvUsuarios.SelectedRows.Count == 0)
                {
                    MessageBox.Show("Debe seleccionar un usuario para modificar.", "Advertencia",
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                var usuarioSeleccionado = (Usuario)dgvUsuarios.SelectedRows[0].DataBoundItem;

                // Verificar que el usuario esté activo antes de permitir modificarlo
                if (usuarioSeleccionado.Estado != "1")
                {
                    MessageBox.Show("No se puede modificar un usuario inactivo. Primero debe habilitarlo.",
                        "Advertencia", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                var frmModificar = new FrmModificarUsuario(usuarioSeleccionado.IdUsuario);
                frmModificar.ShowDialog();
                
                // Recargar la lista después de modificar
                CargarUsuarios();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al modificar usuario: {ex.Message}", "Error",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Maneja el evento de clic del botón Deshabilitar Usuario.
        /// Realiza un soft-delete del usuario (cambia su estado a inactivo).
        /// </summary>
        private void btnDeshabilitarUsuario_Click(object sender, EventArgs e)
        {
            try
            {
                if (dgvUsuarios.SelectedRows.Count == 0)
                {
                    MessageBox.Show("Debe seleccionar un usuario para deshabilitar.", "Advertencia",
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                var usuarioSeleccionado = (Usuario)dgvUsuarios.SelectedRows[0].DataBoundItem;

                // Pedir confirmación antes de deshabilitar
                var confirmacion = MessageBox.Show(
                    $"¿Está seguro que desea deshabilitar al usuario '{usuarioSeleccionado.UserName}'?",
                    "Confirmar",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Question);

                if (confirmacion == DialogResult.Yes)
                {
                    // Llamar al servicio para deshabilitar el usuario
                    UserService.DisableUser(usuarioSeleccionado.IdUsuario);

                    // Recargar la lista para reflejar el cambio
                    CargarUsuarios();

                    MessageBox.Show("Usuario deshabilitado exitosamente.", "Éxito",
                        MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al deshabilitar usuario: {ex.Message}", "Error",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Maneja el evento de clic del botón Habilitar Usuario.
        /// Reactiva un usuario que había sido deshabilitado previamente.
        /// </summary>
        private void btnHabilitarUsuario_Click(object sender, EventArgs e)
        {
            try
            {
                if (dgvUsuarios.SelectedRows.Count == 0)
                {
                    MessageBox.Show("Debe seleccionar un usuario para habilitar.", "Advertencia",
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                var usuarioSeleccionado = (Usuario)dgvUsuarios.SelectedRows[0].DataBoundItem;

                // Pedir confirmación antes de habilitar
                var confirmacion = MessageBox.Show(
                    $"¿Está seguro que desea habilitar al usuario '{usuarioSeleccionado.UserName}'?",
                    "Confirmar",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Question);

                if (confirmacion == DialogResult.Yes)
                {
                    // Llamar al servicio para habilitar el usuario
                    UserService.EnabledUsuario(usuarioSeleccionado.IdUsuario);

                    // Recargar la lista para reflejar el cambio
                    CargarUsuarios();

                    MessageBox.Show("Usuario habilitado exitosamente.", "Éxito",
                        MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al habilitar usuario: {ex.Message}", "Error",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Maneja el evento de clic del botón Asignar Familias.
        /// </summary>
        private void btnAsignarFamilias_Click(object sender, EventArgs e)
        {
            try
            {
                if (dgvUsuarios.SelectedRows.Count == 0)
                {
                    MessageBox.Show("Debe seleccionar un usuario.", "Advertencia",
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                var usuarioSeleccionado = (Usuario)dgvUsuarios.SelectedRows[0].DataBoundItem;

                var frmAsignarFamilias = new FrmAsignarFamilias(usuarioSeleccionado.IdUsuario);
                frmAsignarFamilias.ShowDialog();
                
                // Recargar la lista después de asignar
                CargarUsuarios();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al asignar familias: {ex.Message}", "Error",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Maneja el evento de clic del botón Asignar Patentes.
        /// </summary>
        private void btnAsignarPatentes_Click(object sender, EventArgs e)
        {
            try
            {
                if (dgvUsuarios.SelectedRows.Count == 0)
                {
                    MessageBox.Show("Debe seleccionar un usuario.", "Advertencia",
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                var usuarioSeleccionado = (Usuario)dgvUsuarios.SelectedRows[0].DataBoundItem;

                var frmAsignarPatentes = new FrmAsignarPatentes(usuarioSeleccionado.IdUsuario);
                frmAsignarPatentes.ShowDialog();
                
                // Recargar la lista después de asignar
                CargarUsuarios();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al asignar patentes: {ex.Message}", "Error",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Maneja el evento de clic del botón Filtrar.
        /// Filtra los usuarios según los criterios ingresados.
        /// </summary>
        private void btnFiltrar_Click(object sender, EventArgs e)
        {
            try
            {
                string username = txtFiltroUsername.Text.Trim();
                string dni = txtFiltroDNI.Text.Trim();

                // Si no hay ningún filtro aplicado, cargar todos los usuarios
                if (string.IsNullOrWhiteSpace(username) && string.IsNullOrWhiteSpace(dni))
                {
                    CargarUsuarios();
                    return;
                }

                // Obtener todos los usuarios y filtrar en memoria
                var todosLosUsuarios = UserService.GetAllUsuarios();
                var usuariosFiltrados = todosLosUsuarios.AsEnumerable();

                if (!string.IsNullOrWhiteSpace(username))
                {
                    usuariosFiltrados = usuariosFiltrados.Where(u => 
                        u.UserName != null && u.UserName.ToUpper().Contains(username.ToUpper()));
                }

                if (!string.IsNullOrWhiteSpace(dni))
                {
                    usuariosFiltrados = usuariosFiltrados.Where(u => 
                        u.DNI != null && u.DNI.Contains(dni));
                }

                dgvUsuarios.DataSource = usuariosFiltrados.ToList();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al filtrar usuarios: {ex.Message}", "Error",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Maneja el evento de clic del botón Limpiar Filtros.
        /// Limpia los campos de filtro y recarga todos los usuarios.
        /// </summary>
        private void btnLimpiarFiltros_Click(object sender, EventArgs e)
        {
            // Limpiar todos los campos de filtro
            txtFiltroUsername.Clear();
            txtFiltroDNI.Clear();

            // Recargar todos los usuarios
            CargarUsuarios();
        }

        // Implementación de ILanguageObserver

        /// <summary>
        /// Método llamado automáticamente cuando cambia el idioma.
        /// Traduce el formulario y el DataGridView.
        /// </summary>
        public void UpdateLanguage()
        {
            try
            {
                // Traducir controles del formulario
                LanguageService.TranslateForm(this);

                // Traducir DataGridView si ya tiene columnas configuradas
                if (dgvUsuarios.Columns.Count > 0)
                {
                    // Asignar Tags a columnas para traducción
                    TraducirHeadersDataGridView();
                }
            }
            catch (Exception ex)
            {
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Traduce los encabezados del DataGridView asignando Tags y llamando al servicio.
        /// </summary>
        private void TraducirHeadersDataGridView()
        {
            // Asignar Tags a columnas visibles para traducción
            if (dgvUsuarios.Columns.Contains("UserName"))
                dgvUsuarios.Columns["UserName"].Tag = "Usuario";

            if (dgvUsuarios.Columns.Contains("Nombre"))
                dgvUsuarios.Columns["Nombre"].Tag = "Nombre";

            if (dgvUsuarios.Columns.Contains("Apellido"))
                dgvUsuarios.Columns["Apellido"].Tag = "Apellido";

            if (dgvUsuarios.Columns.Contains("DNI"))
                dgvUsuarios.Columns["DNI"].Tag = "DNI";

            if (dgvUsuarios.Columns.Contains("Email"))
                dgvUsuarios.Columns["Email"].Tag = "Email";

            if (dgvUsuarios.Columns.Contains("Telefono"))
                dgvUsuarios.Columns["Telefono"].Tag = "Telefono";

            // Llamar al servicio para traducir
            LanguageService.TranslateDataGridView(dgvUsuarios);
        }

        /// <summary>
        /// Evento que se ejecuta al cerrar el formulario.
        /// Desuscribe del Observer para evitar memory leaks.
        /// </summary>
        protected override void OnFormClosing(FormClosingEventArgs e)
        {
            LanguageService.Unsubscribe(this);
            base.OnFormClosing(e);
        }
    }
}
