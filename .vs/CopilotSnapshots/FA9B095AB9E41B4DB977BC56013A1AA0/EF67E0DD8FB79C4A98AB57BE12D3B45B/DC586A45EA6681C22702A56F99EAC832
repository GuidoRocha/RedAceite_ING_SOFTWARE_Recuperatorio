using SERVICES.Dominio;
using SERVICES.Facade;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace RedAceite_ING_SOFTWARE.Forms
{
    public partial class FrmCrearRol : Form, ILanguageObserver
    {
        public FrmCrearRol()
        {
            InitializeComponent();

            // Suscribirse al evento Load
            this.Load += FrmCrearRol_Load;

            // Suscribirse al Observer de idioma
            LanguageService.Subscribe(this);
        }

        /// <summary>
        /// Evento que se ejecuta cuando el formulario se carga.
        /// Traduce el formulario según el idioma actual.
        /// </summary>
        private void FrmCrearRol_Load(object sender, EventArgs e)
        {
            LanguageService.TranslateForm(this);
        }

        private void CrearRol_Click(object sender, EventArgs e)
        {
            try
            {

                var nombreFamilia = txtNombreFamilia.Text.Trim();
                if (string.IsNullOrEmpty(nombreFamilia))
                {
                    MessageBox.Show("El nombre de la familia no puede estar vacío.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }


                var patentesSeleccionadas = new List<Patente>();
                foreach (var item in cbPatentes.CheckedItems)
                {
                    var patente = (Patente)item;
                    patentesSeleccionadas.Add(patente);
                }

                if (patentesSeleccionadas.Count == 0)
                {
                    MessageBox.Show("Debe seleccionar al menos una patente.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                // Llamar a la fachada para crear la familia con las patentes seleccionadas
                FamiliaService.CrearFamiliaConPatentes(nombreFamilia, patentesSeleccionadas);

                MessageBox.Show("Familia creada con éxito.");
                this.Close();
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ocurrió un error al crear la familia: {ex.Message}", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        // Implementación de ILanguageObserver

        /// <summary>
        /// Método llamado automáticamente cuando cambia el idioma.
        /// Traduce el formulario.
        /// </summary>
        public void UpdateLanguage()
        {
            try
            {
                LanguageService.TranslateForm(this);
            }
            catch (Exception ex)
            {
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Evento que se ejecuta al cerrar el formulario.
        /// Desuscribe del Observer para evitar memory leaks.
        /// </summary>
        protected override void OnFormClosing(FormClosingEventArgs e)
        {
            LanguageService.Unsubscribe(this);
            base.OnFormClosing(e);
        }
    }
}
