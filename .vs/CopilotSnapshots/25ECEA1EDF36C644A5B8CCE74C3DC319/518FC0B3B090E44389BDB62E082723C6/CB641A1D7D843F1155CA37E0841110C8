using iText.IO.Image;
using iText.Kernel.Colors;
using iText.Kernel.Font;
using iText.Kernel.Geom;
using iText.Kernel.Pdf;
using iText.Layout;
using iText.Layout.Borders;
using iText.Layout.Element;
using iText.Layout.Properties;
using SERVICES.DTO;
using System;
using System.IO;

namespace SERVICES.Helpers
{
    /// <summary>
    /// Helper para generar archivos PDF de remitos utilizando iText7.
    /// Maneja toda la lógica técnica de creación y formateo del documento.
    /// </summary>
    public class PdfGeneratorHelper
    {
        /// <summary>
        /// Crea un archivo PDF de remito con los datos proporcionados.
        /// </summary>
        /// <param name="datos">Datos del remito a incluir en el PDF.</param>
        /// <param name="rutaDestino">Ruta completa donde se guardará el archivo PDF.</param>
        /// <param name="rutaLogo">Ruta completa del archivo de logo a incluir.</param>
        public void CrearRemitoPdf(DatosRemitoPdfDto datos, string rutaDestino, string rutaLogo)
        {
            PdfWriter writer = null;
            PdfDocument pdf = null;
            Document document = null;

            try
            {
                LoggerService.WriteLog($"[PdfGeneratorHelper] === INICIO CREACIÓN PDF ===",
                    System.Diagnostics.TraceLevel.Info);
                LoggerService.WriteLog($"[PdfGeneratorHelper] Ruta destino: {rutaDestino}",
                    System.Diagnostics.TraceLevel.Verbose);
                LoggerService.WriteLog($"[PdfGeneratorHelper] Ruta logo: {rutaLogo}",
                    System.Diagnostics.TraceLevel.Verbose);

                // Crear el escritor PDF
                LoggerService.WriteLog("[PdfGeneratorHelper] Creando PdfWriter...",
                    System.Diagnostics.TraceLevel.Verbose);
                writer = new PdfWriter(rutaDestino);
                
                // Crear el documento PDF con tamaño A4
                LoggerService.WriteLog("[PdfGeneratorHelper] Creando PdfDocument...",
                    System.Diagnostics.TraceLevel.Verbose);
                pdf = new PdfDocument(writer);
                
                // Crear el documento de layout
                LoggerService.WriteLog("[PdfGeneratorHelper] Creando Document...",
                    System.Diagnostics.TraceLevel.Verbose);
                document = new Document(pdf, PageSize.A4);
                
                // Configurar márgenes
                document.SetMargins(30, 30, 30, 30);
                LoggerService.WriteLog("[PdfGeneratorHelper] Márgenes configurados",
                    System.Diagnostics.TraceLevel.Verbose);

                // Agregar contenido al documento
                LoggerService.WriteLog("[PdfGeneratorHelper] Agregando logo...",
                    System.Diagnostics.TraceLevel.Verbose);
                AgregarLogo(document, rutaLogo);

                LoggerService.WriteLog("[PdfGeneratorHelper] Agregando cabecera...",
                    System.Diagnostics.TraceLevel.Verbose);
                AgregarCabecera(document, datos);

                LoggerService.WriteLog("[PdfGeneratorHelper] Agregando datos transportista...",
                    System.Diagnostics.TraceLevel.Verbose);
                AgregarDatosTransportista(document, datos);

                LoggerService.WriteLog("[PdfGeneratorHelper] Agregando datos generador...",
                    System.Diagnostics.TraceLevel.Verbose);
                AgregarDatosGenerador(document, datos);

                LoggerService.WriteLog("[PdfGeneratorHelper] Agregando datos residuo...",
                    System.Diagnostics.TraceLevel.Verbose);
                AgregarDatosResiduo(document, datos);

                LoggerService.WriteLog("[PdfGeneratorHelper] Agregando fecha y firma...",
                    System.Diagnostics.TraceLevel.Verbose);
                AgregarFechaYFirma(document, datos);

                LoggerService.WriteLog("[PdfGeneratorHelper] Agregando texto legal...",
                    System.Diagnostics.TraceLevel.Verbose);
                AgregarTextoLegal(document);

                // Solo agregar sección de envío si se requiere
                if (datos.RequiereEnvio)
                {
                    LoggerService.WriteLog("[PdfGeneratorHelper] Agregando datos de envío...",
                        System.Diagnostics.TraceLevel.Verbose);
                    AgregarDatosEnvio(document, datos);
                }

                LoggerService.WriteLog("[PdfGeneratorHelper] Agregando pie...",
                    System.Diagnostics.TraceLevel.Verbose);
                AgregarPie(document);

                LoggerService.WriteLog("[PdfGeneratorHelper] Contenido agregado exitosamente",
                    System.Diagnostics.TraceLevel.Info);
            }
            catch (Exception ex)
            {
                LoggerService.WriteLog($"[PdfGeneratorHelper] ERROR CRÍTICO al crear PDF: {ex.Message}",
                    System.Diagnostics.TraceLevel.Error);
                LoggerService.WriteLog($"[PdfGeneratorHelper] StackTrace: {ex.StackTrace}",
                    System.Diagnostics.TraceLevel.Error);
                
                if (ex.InnerException != null)
                {
                    LoggerService.WriteLog($"[PdfGeneratorHelper] InnerException: {ex.InnerException.Message}",
                        System.Diagnostics.TraceLevel.Error);
                    LoggerService.WriteLog($"[PdfGeneratorHelper] InnerException StackTrace: {ex.InnerException.StackTrace}",
                        System.Diagnostics.TraceLevel.Error);
                }

                throw new Exception($"Error al generar el PDF: {ex.Message}", ex);
            }
            finally
            {
                // Asegurarse de cerrar todo en el orden correcto
                try
                {
                    if (document != null)
                    {
                        LoggerService.WriteLog("[PdfGeneratorHelper] Cerrando Document...",
                            System.Diagnostics.TraceLevel.Verbose);
                        document.Close();
                        LoggerService.WriteLog("[PdfGeneratorHelper] Document cerrado OK",
                            System.Diagnostics.TraceLevel.Verbose);
                    }
                }
                catch (Exception ex)
                {
                    LoggerService.WriteLog($"[PdfGeneratorHelper] Error al cerrar Document: {ex.Message}",
                        System.Diagnostics.TraceLevel.Warning);
                }

                try
                {
                    if (pdf != null)
                    {
                        LoggerService.WriteLog("[PdfGeneratorHelper] Cerrando PdfDocument...",
                            System.Diagnostics.TraceLevel.Verbose);
                        pdf.Close();
                        LoggerService.WriteLog("[PdfGeneratorHelper] PdfDocument cerrado OK",
                            System.Diagnostics.TraceLevel.Verbose);
                    }
                }
                catch (Exception ex)
                {
                    LoggerService.WriteLog($"[PdfGeneratorHelper] Error al cerrar PdfDocument: {ex.Message}",
                        System.Diagnostics.TraceLevel.Warning);
                }

                try
                {
                    if (writer != null)
                    {
                        LoggerService.WriteLog("[PdfGeneratorHelper] Cerrando PdfWriter...",
                            System.Diagnostics.TraceLevel.Verbose);
                        writer.Close();
                        LoggerService.WriteLog("[PdfGeneratorHelper] PdfWriter cerrado OK",
                            System.Diagnostics.TraceLevel.Verbose);
                    }
                }
                catch (Exception ex)
                {
                    LoggerService.WriteLog($"[PdfGeneratorHelper] Error al cerrar PdfWriter: {ex.Message}",
                        System.Diagnostics.TraceLevel.Warning);
                }

                LoggerService.WriteLog("[PdfGeneratorHelper] === FIN CREACIÓN PDF ===",
                    System.Diagnostics.TraceLevel.Info);
            }
        }

        /// <summary>
        /// Agrega el logo de RedAceite en la parte superior del documento.
        /// Si el logo no existe o falla, continúa sin él y registra advertencia.
        /// </summary>
        private void AgregarLogo(Document document, string rutaLogo)
        {
            try
            {
                // Validar que se proporcionó una ruta
                if (string.IsNullOrWhiteSpace(rutaLogo))
                {
                    LoggerService.WriteLog("[PdfGeneratorHelper] No se proporcionó ruta del logo. Continuando sin logo.",
                        System.Diagnostics.TraceLevel.Warning);
                    return;
                }

                // Validar que el archivo existe
                if (!File.Exists(rutaLogo))
                {
                    LoggerService.WriteLog($"[PdfGeneratorHelper] Logo no encontrado en: {rutaLogo}. Continuando sin logo.",
                        System.Diagnostics.TraceLevel.Warning);
                    return;
                }

                LoggerService.WriteLog($"[PdfGeneratorHelper] Intentando cargar logo desde: {rutaLogo}",
                    System.Diagnostics.TraceLevel.Verbose);

                // Intentar cargar el logo
                ImageData imageData = ImageDataFactory.Create(rutaLogo);
                Image logo = new Image(imageData);
                
                // Escalar el logo manteniendo proporciones
                logo.ScaleToFit(150, 80);
                logo.SetHorizontalAlignment(HorizontalAlignment.LEFT);
                
                document.Add(logo);

                LoggerService.WriteLog("[PdfGeneratorHelper] Logo agregado exitosamente al PDF",
                    System.Diagnostics.TraceLevel.Verbose);
            }
            catch (Exception ex)
            {
                // Si falla el logo, registrar advertencia pero NO lanzar excepción
                LoggerService.WriteLog($"[PdfGeneratorHelper] Error al agregar logo: {ex.Message}. Continuando sin logo.",
                    System.Diagnostics.TraceLevel.Warning);
                
                if (ex.InnerException != null)
                {
                    LoggerService.WriteLog($"[PdfGeneratorHelper] InnerException: {ex.InnerException.Message}",
                        System.Diagnostics.TraceLevel.Warning);
                }

                // NO lanzar la excepción - el PDF puede generarse sin logo
            }
        }

        /// <summary>
        /// Agrega la cabecera del remito con título y número.
        /// </summary>
        private void AgregarCabecera(Document document, DatosRemitoPdfDto datos)
        {
            // Título principal
            Paragraph titulo1 = new Paragraph("REDACEITE")
                .SetFontSize(20)
                .SetTextAlignment(TextAlignment.CENTER)
                .SetFontColor(new DeviceRgb(0, 128, 0)); // Verde

            Paragraph titulo2 = new Paragraph("SERVICIOS ECOLÓGICOS")
                .SetFontSize(14)
                .SetTextAlignment(TextAlignment.CENTER);

            // Número de remito
            Paragraph numeroRemito = new Paragraph($"N° {datos.NumeroRemito}")
                .SetFontSize(12)
                .SetTextAlignment(TextAlignment.RIGHT);

            document.Add(titulo1);
            document.Add(titulo2);
            document.Add(numeroRemito);
            document.Add(new Paragraph("\n"));

            // Subtítulo legal
            Paragraph subtitulo = new Paragraph("CONSTANCIA de TRANSPORTE de RESIDUOS INDUSTRIAL NO ESPECIAL")
                .SetFontSize(10)
                .SetTextAlignment(TextAlignment.CENTER)
                .SetBackgroundColor(new DeviceRgb(200, 200, 200))
                .SetPadding(5);

            document.Add(subtitulo);

            // Resoluciones
            Paragraph resoluciones = new Paragraph("Resolución SPA n°063/96 - Resoluciones OPDS n°04/08 y 198/10")
                .SetFontSize(8)
                .SetTextAlignment(TextAlignment.CENTER);

            document.Add(resoluciones);
            document.Add(new Paragraph("\n"));
        }

        /// <summary>
        /// Agrega los datos del transportista al documento.
        /// </summary>
        private void AgregarDatosTransportista(Document document, DatosRemitoPdfDto datos)
        {
            Table tabla = new Table(2).UseAllAvailableWidth();
            tabla.SetBorder(new SolidBorder(1));

            // Nombre del transportista
            tabla.AddCell(CrearCeldaEtiqueta("Nombre del Transportista:"));
            tabla.AddCell(CrearCeldaDato(datos.NombreTransportista));

            // Teléfono
            tabla.AddCell(CrearCeldaEtiqueta("Tel:"));
            tabla.AddCell(CrearCeldaDato(datos.TelefonoTransportista));

            // Domicilio
            tabla.AddCell(CrearCeldaEtiqueta("Domicilio:"));
            tabla.AddCell(CrearCeldaDato(datos.DomicilioTransportista));

            document.Add(tabla);
            document.Add(new Paragraph("\n"));
        }

        /// <summary>
        /// Agrega los datos del generador (proveedor) al documento.
        /// </summary>
        private void AgregarDatosGenerador(Document document, DatosRemitoPdfDto datos)
        {
            Table tabla = new Table(2).UseAllAvailableWidth();
            tabla.SetBorder(new SolidBorder(1));

            // Nombre del generador
            tabla.AddCell(CrearCeldaEtiqueta("Nombre del Generador:"));
            tabla.AddCell(CrearCeldaDato(datos.NombreGenerador));

            // Domicilio de la planta
            tabla.AddCell(CrearCeldaEtiqueta("Domicilio de la Planta:"));
            tabla.AddCell(CrearCeldaDato(datos.DomicilioPlanta));

            document.Add(tabla);
            document.Add(new Paragraph("\n"));
        }

        /// <summary>
        /// Agrega los datos del residuo al documento.
        /// </summary>
        private void AgregarDatosResiduo(Document document, DatosRemitoPdfDto datos)
        {
            Table tabla = new Table(2).UseAllAvailableWidth();
            tabla.SetBorder(new SolidBorder(1));

            // Tipo de residuo
            tabla.AddCell(CrearCeldaEtiqueta("Tipo de Residuos:"));
            tabla.AddCell(CrearCeldaDato(datos.TipoResiduo.ToUpper()));

            // Cantidad
            string unidad = datos.Estado == "Líquido" ? "L" : "Kg";
            tabla.AddCell(CrearCeldaEtiqueta("Cantidad:"));
            tabla.AddCell(CrearCeldaDato($"{datos.Cantidad:N2} {unidad}"));

            // Estado
            tabla.AddCell(CrearCeldaEtiqueta("Estado:"));
            tabla.AddCell(CrearCeldaDato(datos.Estado.ToUpper()));

            document.Add(tabla);
            document.Add(new Paragraph("\n"));
        }

        /// <summary>
        /// Agrega la fecha de entrega y espacio para firma.
        /// </summary>
        private void AgregarFechaYFirma(Document document, DatosRemitoPdfDto datos)
        {
            Table tabla = new Table(2).UseAllAvailableWidth();
            tabla.SetBorder(Border.NO_BORDER);

            // Fecha de entrega
            Paragraph fecha = new Paragraph($"Fecha de Entrega: {datos.FechaCreacion:dd/MM/yyyy}")
                .SetFontSize(10);

            Cell celdaFecha = new Cell()
                .Add(fecha)
                .SetBorder(Border.NO_BORDER)
                .SetTextAlignment(TextAlignment.LEFT);

            // Espacio para firma
            Paragraph firma = new Paragraph("\n\n_______________________________\nFirma")
                .SetFontSize(10)
                .SetTextAlignment(TextAlignment.CENTER);

            Cell celdaFirma = new Cell()
                .Add(firma)
                .SetBorder(Border.NO_BORDER)
                .SetTextAlignment(TextAlignment.RIGHT);

            tabla.AddCell(celdaFecha);
            tabla.AddCell(celdaFirma);

            document.Add(tabla);
            document.Add(new Paragraph("\n"));
        }

        /// <summary>
        /// Agrega el texto legal informativo.
        /// </summary>
        private void AgregarTextoLegal(Document document)
        {
            Paragraph textoLegal = new Paragraph(
                "Sirve la Firma de este documento para la auto declaración de " +
                "sustentabilidad ISCC para los países de la Unión Europea según la " +
                "directiva 2009/28/CE. Este establecimiento no genera más de 10.000 lts mensuales. " +
                "Para la admisión de residuos al Ministerio de Ambiente de la " +
                "Provincia de Buenos Aires\nDe requerir envío:")
                .SetFontSize(7)
                .SetTextAlignment(TextAlignment.JUSTIFIED);

            document.Add(textoLegal);
            document.Add(new Paragraph("\n"));
        }

        /// <summary>
        /// Agrega los datos de envío si se requiere.
        /// </summary>
        private void AgregarDatosEnvio(Document document, DatosRemitoPdfDto datos)
        {
            Paragraph titulo = new Paragraph("Se requiere envío:")
                .SetFontSize(11);

            document.Add(titulo);

            Table tabla = new Table(2).UseAllAvailableWidth();
            tabla.SetBorder(new SolidBorder(1));

            // CUIT
            tabla.AddCell(CrearCeldaEtiqueta("*CUIT:"));
            tabla.AddCell(CrearCeldaDato(datos.Cuit));

            // Nombre de fantasía
            tabla.AddCell(CrearCeldaEtiqueta("*Nombre de Fantasía:"));
            tabla.AddCell(CrearCeldaDato(datos.NombreFantasia));

            // Dirección
            tabla.AddCell(CrearCeldaEtiqueta("*Dirección:"));
            tabla.AddCell(CrearCeldaDato(datos.DireccionEnvio));

            document.Add(tabla);
            document.Add(new Paragraph("\n"));

            // Email
            Paragraph email = new Paragraph(
                "*Dirección de mail a nuestra casilla: Info@redaceite.com.ar\n" +
                "                                                          hugorocha7473@hotmail.com.ar")
                .SetFontSize(8);

            document.Add(email);
        }

        /// <summary>
        /// Agrega el pie de página con información de contacto.
        /// </summary>
        private void AgregarPie(Document document)
        {
            document.Add(new Paragraph("\n"));

            Paragraph whatsapp = new Paragraph("📱 (011)114-4917473")
                .SetFontSize(12)
                .SetTextAlignment(TextAlignment.CENTER);

            document.Add(whatsapp);
        }

        /// <summary>
        /// Crea una celda formateada para etiquetas.
        /// </summary>
        private Cell CrearCeldaEtiqueta(string texto)
        {
            return new Cell()
                .Add(new Paragraph(texto)
                    .SetFontSize(9))
                .SetBackgroundColor(new DeviceRgb(240, 240, 240))
                .SetPadding(5);
        }

        /// <summary>
        /// Crea una celda formateada para datos.
        /// </summary>
        private Cell CrearCeldaDato(string texto)
        {
            return new Cell()
                .Add(new Paragraph(texto ?? "")
                    .SetFontSize(9))
                .SetPadding(5);
        }
    }
}
