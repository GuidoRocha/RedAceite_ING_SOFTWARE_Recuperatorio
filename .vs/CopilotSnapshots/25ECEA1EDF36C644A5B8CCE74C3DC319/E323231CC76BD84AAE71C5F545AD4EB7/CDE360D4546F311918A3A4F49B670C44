using DAL.Contratos;
using DAL.Helpers;
using DOMAIN;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;

namespace DAL.Implementaciones
{
    /// <summary>
    /// Implementación del repositorio para gestión de PDFs de remitos.
    /// Maneja las operaciones CRUD contra la tabla RemitoPDF en SQL Server.
    /// </summary>
    public class RemitoPdfRepository : IRemitoPdfRepository
    {
        /// <summary>
        /// Constructor por defecto del repositorio de PDFs de remitos.
        /// </summary>
        public RemitoPdfRepository()
        {
        }

        #region Métodos específicos de IRemitoPdfRepository

        /// <summary>
        /// Guarda el registro de un PDF generado en la base de datos.
        /// </summary>
        public void GuardarRegistroPdf(RemitoPDF remitoPdf)
        {
            string query = @"INSERT INTO RemitoPDF 
                            (IdRemitoPDF, IdRemito, NombreArchivo, FechaGeneracion, TamañoBytes, HashMD5)
                            VALUES 
                            (@IdRemitoPDF, @IdRemito, @NombreArchivo, @FechaGeneracion, @TamañoBytes, @HashMD5)";

            SqlHelper.ExecuteNonQueryWithConnection(query, CommandType.Text,
                SqlHelper.conStringRemitos,
                new SqlParameter("@IdRemitoPDF", remitoPdf.IdRemitoPDF),
                new SqlParameter("@IdRemito", remitoPdf.IdRemito),
                new SqlParameter("@NombreArchivo", remitoPdf.NombreArchivo),
                new SqlParameter("@FechaGeneracion", remitoPdf.FechaGeneracion),
                new SqlParameter("@TamañoBytes", remitoPdf.TamañoBytes),
                new SqlParameter("@HashMD5", (object)remitoPdf.HashMD5 ?? DBNull.Value));
        }

        /// <summary>
        /// Obtiene el registro PDF asociado a un remito específico.
        /// </summary>
        public RemitoPDF ObtenerPorIdRemito(Guid idRemito)
        {
            RemitoPDF remitoPdf = null;

            string query = @"SELECT IdRemitoPDF, IdRemito, NombreArchivo, FechaGeneracion, TamañoBytes, HashMD5
                             FROM RemitoPDF 
                             WHERE IdRemito = @IdRemito";

            using (SqlDataReader reader = SqlHelper.ExecuteReaderWithConnection(
                query, CommandType.Text, SqlHelper.conStringRemitos,
                new SqlParameter("@IdRemito", idRemito)))
            {
                if (reader.Read())
                {
                    remitoPdf = MapearRemitoPdf(reader);
                }
            }

            return remitoPdf;
        }

        /// <summary>
        /// Obtiene el registro PDF por nombre de archivo.
        /// </summary>
        public RemitoPDF ObtenerPorNombreArchivo(string nombreArchivo)
        {
            RemitoPDF remitoPdf = null;

            string query = @"SELECT IdRemitoPDF, IdRemito, NombreArchivo, FechaGeneracion, TamañoBytes, HashMD5
                             FROM RemitoPDF 
                             WHERE NombreArchivo = @NombreArchivo";

            using (SqlDataReader reader = SqlHelper.ExecuteReaderWithConnection(
                query, CommandType.Text, SqlHelper.conStringRemitos,
                new SqlParameter("@NombreArchivo", nombreArchivo)))
            {
                if (reader.Read())
                {
                    remitoPdf = MapearRemitoPdf(reader);
                }
            }

            return remitoPdf;
        }

        /// <summary>
        /// Verifica si ya existe un PDF generado para un remito específico.
        /// </summary>
        public bool ExistePdfParaRemito(Guid idRemito)
        {
            string query = @"SELECT COUNT(1) FROM RemitoPDF WHERE IdRemito = @IdRemito";

            int count = (int)SqlHelper.ExecuteScalarWithConnection(
                query, CommandType.Text, SqlHelper.conStringRemitos,
                new SqlParameter("@IdRemito", idRemito));

            return count > 0;
        }

        /// <summary>
        /// Obtiene todos los PDFs generados en un rango de fechas.
        /// </summary>
        public List<RemitoPDF> ObtenerPorRangoFechas(DateTime fechaInicio, DateTime fechaFin)
        {
            List<RemitoPDF> remitoPdfs = new List<RemitoPDF>();

            string query = @"SELECT IdRemitoPDF, IdRemito, NombreArchivo, FechaGeneracion, TamañoBytes, HashMD5
                             FROM RemitoPDF 
                             WHERE FechaGeneracion BETWEEN @FechaInicio AND @FechaFin
                             ORDER BY FechaGeneracion DESC";

            using (SqlDataReader reader = SqlHelper.ExecuteReaderWithConnection(
                query, CommandType.Text, SqlHelper.conStringRemitos,
                new SqlParameter("@FechaInicio", fechaInicio),
                new SqlParameter("@FechaFin", fechaFin)))
            {
                while (reader.Read())
                {
                    remitoPdfs.Add(MapearRemitoPdf(reader));
                }
            }

            return remitoPdfs;
        }

        /// <summary>
        /// Actualiza el hash MD5 de un PDF existente.
        /// </summary>
        public void ActualizarHashMD5(Guid idRemitoPdf, string nuevoHashMD5)
        {
            string query = @"UPDATE RemitoPDF 
                           SET HashMD5 = @HashMD5
                           WHERE IdRemitoPDF = @IdRemitoPDF";

            SqlHelper.ExecuteNonQueryWithConnection(query, CommandType.Text,
                SqlHelper.conStringRemitos,
                new SqlParameter("@HashMD5", nuevoHashMD5),
                new SqlParameter("@IdRemitoPDF", idRemitoPdf));
        }

        #endregion

        #region Métodos de IGenericRepository<RemitoPDF>

        /// <summary>
        /// Agrega un nuevo registro de PDF.
        /// </summary>
        public void Add(RemitoPDF entity)
        {
            GuardarRegistroPdf(entity);
        }

        /// <summary>
        /// Actualiza un registro de PDF existente.
        /// </summary>
        public void Update(RemitoPDF entity)
        {
            string query = @"UPDATE RemitoPDF 
                            SET IdRemito = @IdRemito,
                                NombreArchivo = @NombreArchivo,
                                FechaGeneracion = @FechaGeneracion,
                                TamañoBytes = @TamañoBytes,
                                HashMD5 = @HashMD5
                            WHERE IdRemitoPDF = @IdRemitoPDF";

            SqlHelper.ExecuteNonQueryWithConnection(query, CommandType.Text,
                SqlHelper.conStringRemitos,
                new SqlParameter("@IdRemitoPDF", entity.IdRemitoPDF),
                new SqlParameter("@IdRemito", entity.IdRemito),
                new SqlParameter("@NombreArchivo", entity.NombreArchivo),
                new SqlParameter("@FechaGeneracion", entity.FechaGeneracion),
                new SqlParameter("@TamañoBytes", entity.TamañoBytes),
                new SqlParameter("@HashMD5", (object)entity.HashMD5 ?? DBNull.Value));
        }

        /// <summary>
        /// Elimina un registro de PDF (elimina el registro, no el archivo físico).
        /// </summary>
        public void Remove(Guid id)
        {
            string query = @"DELETE FROM RemitoPDF WHERE IdRemitoPDF = @IdRemitoPDF";

            SqlHelper.ExecuteNonQueryWithConnection(query, CommandType.Text,
                SqlHelper.conStringRemitos,
                new SqlParameter("@IdRemitoPDF", id));
        }

        /// <summary>
        /// Obtiene un registro de PDF por su ID.
        /// </summary>
        public RemitoPDF GetById(Guid id)
        {
            RemitoPDF remitoPdf = null;

            string query = @"SELECT IdRemitoPDF, IdRemito, NombreArchivo, FechaGeneracion, TamañoBytes, HashMD5
                             FROM RemitoPDF 
                             WHERE IdRemitoPDF = @IdRemitoPDF";

            using (SqlDataReader reader = SqlHelper.ExecuteReaderWithConnection(
                query, CommandType.Text, SqlHelper.conStringRemitos,
                new SqlParameter("@IdRemitoPDF", id)))
            {
                if (reader.Read())
                {
                    remitoPdf = MapearRemitoPdf(reader);
                }
            }

            return remitoPdf;
        }

        /// <summary>
        /// Obtiene todos los registros de PDFs.
        /// </summary>
        public List<RemitoPDF> GetAll()
        {
            List<RemitoPDF> remitoPdfs = new List<RemitoPDF>();

            string query = @"SELECT IdRemitoPDF, IdRemito, NombreArchivo, FechaGeneracion, TamañoBytes, HashMD5
                             FROM RemitoPDF
                             ORDER BY FechaGeneracion DESC";

            using (SqlDataReader reader = SqlHelper.ExecuteReaderWithConnection(
                query, CommandType.Text, SqlHelper.conStringRemitos))
            {
                while (reader.Read())
                {
                    remitoPdfs.Add(MapearRemitoPdf(reader));
                }
            }

            return remitoPdfs;
        }

        #endregion

        #region Métodos auxiliares de mapeo

        /// <summary>
        /// Mapea un SqlDataReader a un objeto RemitoPDF.
        /// </summary>
        private RemitoPDF MapearRemitoPdf(SqlDataReader reader)
        {
            return new RemitoPDF
            {
                IdRemitoPDF = reader.GetGuid(0),
                IdRemito = reader.GetGuid(1),
                NombreArchivo = reader.GetString(2),
                FechaGeneracion = reader.GetDateTime(3),
                TamañoBytes = reader.GetInt64(4),
                HashMD5 = reader.IsDBNull(5) ? null : reader.GetString(5)
            };
        }

        #endregion
    }
}
