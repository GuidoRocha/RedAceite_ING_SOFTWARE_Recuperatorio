using DAL.Contratos;
using DAL.Implementaciones;
using SERVICES.Facade;
using System;
using System.Collections.Generic;
using DomainRemito = DOMAIN.Remito;

namespace BLL
{
    /// <summary>
    /// Servicio de lógica de negocio para la gestión de remitos.
    /// Coordina las operaciones entre la capa de presentación y la capa de acceso a datos.
    /// </summary>
    public class RemitoService
    {
        private readonly IRemitoRepository _remitoRepository;
        private readonly RemitoPdfService _remitoPdfService;

        /// <summary>
        /// Constructor que inicializa el repositorio de remitos y el servicio de PDF.
        /// </summary>
        public RemitoService()
        {
            _remitoRepository = new RemitoRepository();
            _remitoPdfService = new RemitoPdfService();
        }

        /// <summary>
        /// Constructor que permite inyectar una implementación específica del repositorio (para testing).
        /// </summary>
        /// <param name="remitoRepository">El repositorio de remitos.</param>
        public RemitoService(IRemitoRepository remitoRepository)
        {
            _remitoRepository = remitoRepository;
            _remitoPdfService = new RemitoPdfService();
        }

        /// <summary>
        /// Genera un nuevo remito en el sistema.
        /// </summary>
        /// <param name="nombreGenerador">Nombre del generador del residuo.</param>
        /// <param name="domicilioPlanta">Domicilio de la planta donde se genera el residuo.</param>
        /// <param name="tipoResiduo">Tipo de residuo (Aceite o Grasa).</param>
        /// <param name="cantidad">Cantidad del residuo recolectado.</param>
        /// <param name="estado">Estado físico del residuo (Líquido o Sólido).</param>
        /// <param name="cuit">CUIT del generador del residuo.</param>
        /// <param name="nombreFantasia">Nombre de fantasía de la empresa generadora.</param>
        /// <param name="direccion">Dirección del establecimiento generador.</param>
        /// <returns>El ID del remito generado.</returns>
        public Guid GenerarRemito(
            string nombreGenerador,
            string domicilioPlanta,
            string tipoResiduo,
            decimal cantidad,
            string estado,
            string cuit,
            string nombreFantasia,
            string direccion)
        {
            // Crear el objeto remito con los datos proporcionados
            var remito = new DomainRemito
            {
                NombreGenerador = nombreGenerador,
                DomicilioPlanta = domicilioPlanta,
                TipoResiduo = tipoResiduo,
                Cantidad = cantidad,
                Estado = estado,
                Cuit = cuit,
                NombreFantasia = nombreFantasia,
                Direccion = direccion,
                // Los datos del transportista se establecen por defecto
                NombreTransportista = "Hugo Rocha",
                DomicilioTransportista = "Mendoza 3149 San Andres Prov. de Bs.As."
            };

            // Validar y crear el remito
            CrearRemito(remito);

            // **INTEGRACIÓN CON INVENTARIO: Registrar entrada automática en inventario**
            try
            {
                var inventarioService = new InventarioService();
                inventarioService.RegistrarEntradaDesdeRemito(
                    tipoResiduo, 
                    estado, 
                    cantidad, 
                    remito.IdRemito, 
                    $"Generador: {nombreGenerador}"
                );

                LoggerService.WriteLog(
                    $"Inventario actualizado automáticamente para remito {remito.IdRemito}",
                    System.Diagnostics.TraceLevel.Info);
            }
            catch (Exception ex)
            {
                // Si falla la actualización del inventario, registramos advertencia
                // pero no cancelamos el remito ya creado
                LoggerService.WriteLog(
                    $"Advertencia: Remito {remito.IdRemito} creado pero error al actualizar inventario. {ex.Message}",
                    System.Diagnostics.TraceLevel.Warning);
                LoggerService.WriteException(ex);
            }

            // **INTEGRACIÓN CON PDF: Generar PDF del remito automáticamente**
            try
            {
                LoggerService.WriteLog(
                    $"Iniciando generación de PDF para remito {remito.IdRemito}",
                    System.Diagnostics.TraceLevel.Info);

                var remitoPdf = _remitoPdfService.GenerarPdfRemito(remito.IdRemito);

                LoggerService.WriteLog(
                    $"PDF generado exitosamente para remito {remito.IdRemito}. Archivo: {remitoPdf.NombreArchivo}",
                    System.Diagnostics.TraceLevel.Info);
            }
            catch (Exception ex)
            {
                // Si falla la generación del PDF, registramos advertencia
                // pero NO cancelamos el remito (según decisión acordada)
                LoggerService.WriteLog(
                    $"ADVERTENCIA: Remito {remito.IdRemito} creado pero error al generar PDF. {ex.Message}",
                    System.Diagnostics.TraceLevel.Warning);
                LoggerService.WriteException(ex);
            }

            return remito.IdRemito;
        }

        /// <summary>
        /// Crea un nuevo remito en el sistema.
        /// Valida los datos antes de persistirlos en la base de datos.
        /// </summary>
        /// <param name="remito">El remito a crear.</param>
        public void CrearRemito(DomainRemito remito)
        {
            // Validaciones de negocio
            ValidarRemito(remito);

            // Establecer valores por defecto si no están definidos
            if (string.IsNullOrWhiteSpace(remito.NombreTransportista))
            {
                remito.NombreTransportista = "Hugo Rocha";
            }

            if (string.IsNullOrWhiteSpace(remito.DomicilioTransportista))
            {
                remito.DomicilioTransportista = "Mendoza 3149 San Andres Prov. de Bs.As.";
            }

            // Asegurar que la fecha de creación esté establecida
            if (remito.FechaCreacion == DateTime.MinValue)
            {
                remito.FechaCreacion = DateTime.Now;
            }

            // Asegurar que el estado del remito esté establecido
            if (string.IsNullOrWhiteSpace(remito.EstadoRemito))
            {
                remito.EstadoRemito = "Activo";
            }

            // Crear el remito en la base de datos
            _remitoRepository.CreateRemito(remito);
        }

        /// <summary>
        /// Obtiene un remito por su identificador único.
        /// </summary>
        /// <param name="idRemito">El ID del remito.</param>
        /// <returns>El remito correspondiente, si existe.</returns>
        public Remito ObtenerRemitoPorId(Guid idRemito)
        {
            return _remitoRepository.GetRemitoById(idRemito);
        }

        /// <summary>
        /// Obtiene todos los remitos registrados en el sistema.
        /// </summary>
        /// <returns>Una lista de todos los remitos.</returns>
        public List<Remito> ObtenerTodosLosRemitos()
        {
            return _remitoRepository.GetAllRemitos();
        }

        /// <summary>
        /// Obtiene los remitos filtrados por CUIT del generador.
        /// </summary>
        /// <param name="cuit">El CUIT del generador.</param>
        /// <returns>Una lista de remitos asociados al CUIT especificado.</returns>
        public List<Remito> ObtenerRemitosPorCuit(string cuit)
        {
            if (string.IsNullOrWhiteSpace(cuit))
            {
                throw new ArgumentException("El CUIT no puede estar vacío.", nameof(cuit));
            }

            return _remitoRepository.GetRemitosByCuit(cuit);
        }

        /// <summary>
        /// Obtiene los remitos creados en un rango de fechas.
        /// </summary>
        /// <param name="fechaInicio">Fecha de inicio del rango.</param>
        /// <param name="fechaFin">Fecha de fin del rango.</param>
        /// <returns>Una lista de remitos dentro del rango de fechas.</returns>
        public List<Remito> ObtenerRemitosPorFechaRango(DateTime fechaInicio, DateTime fechaFin)
        {
            if (fechaInicio > fechaFin)
            {
                throw new ArgumentException("La fecha de inicio no puede ser mayor a la fecha de fin.");
            }

            return _remitoRepository.GetRemitosByFechaRango(fechaInicio, fechaFin);
        }

        /// <summary>
        /// Anula un remito existente.
        /// </summary>
        /// <param name="idRemito">El ID del remito a anular.</param>
        public void AnularRemito(Guid idRemito)
        {
            // Verificar que el remito existe
            var remito = _remitoRepository.GetRemitoById(idRemito);
            if (remito == null)
            {
                throw new Exception("El remito no existe.");
            }

            // Verificar que el remito no esté ya anulado
            if (remito.EstadoRemito == "Anulado")
            {
                throw new Exception("El remito ya se encuentra anulado.");
            }

            _remitoRepository.AnularRemito(idRemito);
        }

        /// <summary>
        /// Actualiza un remito existente.
        /// </summary>
        /// <param name="remito">El remito con los datos actualizados.</param>
        public void ActualizarRemito(Remito remito)
        {
            // Validar el remito
            ValidarRemito(remito);

            // Verificar que el remito existe
            var remitoExistente = _remitoRepository.GetRemitoById(remito.IdRemito);
            if (remitoExistente == null)
            {
                throw new Exception("El remito no existe.");
            }

            _remitoRepository.Update(remito);
        }

        /// <summary>
        /// Valida los datos de un remito antes de persistirlo.
        /// </summary>
        /// <param name="remito">El remito a validar.</param>
        private void ValidarRemito(Remito remito)
        {
            if (remito == null)
            {
                throw new ArgumentNullException(nameof(remito), "El remito no puede ser nulo.");
            }

            if (string.IsNullOrWhiteSpace(remito.NombreGenerador))
            {
                throw new ArgumentException("El nombre del generador es obligatorio.", nameof(remito.NombreGenerador));
            }

            if (string.IsNullOrWhiteSpace(remito.DomicilioPlanta))
            {
                throw new ArgumentException("El domicilio de la planta es obligatorio.", nameof(remito.DomicilioPlanta));
            }

            if (string.IsNullOrWhiteSpace(remito.TipoResiduo))
            {
                throw new ArgumentException("El tipo de residuo es obligatorio.", nameof(remito.TipoResiduo));
            }

            if (remito.Cantidad <= 0)
            {
                throw new ArgumentException("La cantidad debe ser mayor a cero.", nameof(remito.Cantidad));
            }

            if (string.IsNullOrWhiteSpace(remito.Estado))
            {
                throw new ArgumentException("El estado es obligatorio.", nameof(remito.Estado));
            }

            if (string.IsNullOrWhiteSpace(remito.Cuit))
            {
                throw new ArgumentException("El CUIT es obligatorio.", nameof(remito.Cuit));
            }

            if (string.IsNullOrWhiteSpace(remito.NombreFantasia))
            {
                throw new ArgumentException("El nombre de fantasía es obligatorio.", nameof(remito.NombreFantasia));
            }

            if (string.IsNullOrWhiteSpace(remito.Direccion))
            {
                throw new ArgumentException("La dirección es obligatoria.", nameof(remito.Direccion));
            }
        }
    }
}