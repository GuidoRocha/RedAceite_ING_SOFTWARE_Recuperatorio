using System;
using System.Windows.Forms;
using BLL;
using SERVICES.Facade;

namespace RedAceite_ING_SOFTWARE.Forms
{
    public partial class FrmPrincipal : Form
    {
        private Form activeForm = null;
        private System.Windows.Forms.Timer timerActualizacion;

        public FrmPrincipal()
        {
            InitializeComponent();
            this.Tag = "Titulo_FrmPrincipal";

            // Mantener suscripción explícita (además del handler del Designer)
            this.Load += FrmPrincipal_Load;

            InicializarTimerActualizacion();
        }

        private void FrmPrincipal_Load(object sender, EventArgs e)
        {
            try
            {
                if (btnProfile != null)
                {
                    btnProfile.Region = System.Drawing.Region.FromHrgn(
                        CreateRoundRectRgn(0, 0, btnProfile.Width, btnProfile.Height, 20, 20));
                }

                CargarEstadisticasInventario();
            }
            catch (Exception ex)
            {
                LoggerService.WriteException(ex);
            }
        }

        // Handler requerido por el Designer
        private void FrmPrincipal_Load_1(object sender, EventArgs e)
        {
            FrmPrincipal_Load(sender, e);
        }

        [System.Runtime.InteropServices.DllImport("Gdi32.dll", EntryPoint = "CreateRoundRectRgn")]
        private static extern IntPtr CreateRoundRectRgn(int nLeftRect, int nTopRect, int nRightRect, int nBottomRect,
            int nWidthEllipse, int nHeightEllipse);

        private void OpenChildForm(Form childForm)
        {
            if (childForm == null) return;

            if (activeForm != null)
            {
                try
                {
                    activeForm.Close();
                }
                catch
                {
                    // ignore
                }

                activeForm.Dispose();
                activeForm = null;
            }

            activeForm = childForm;

            childForm.TopLevel = false;
            childForm.FormBorderStyle = FormBorderStyle.None;
            childForm.Dock = DockStyle.Fill;

            panelMain.Controls.Clear();
            panelMain.Controls.Add(childForm);
            panelMain.Tag = childForm;
            childForm.BringToFront();
            childForm.Show();
        }

        private void VolverAInicio()
        {
            if (activeForm != null)
            {
                try
                {
                    activeForm.Close();
                }
                catch
                {
                    // ignore
                }

                activeForm.Dispose();
                activeForm = null;
            }

            panelMain.Controls.Clear();
            panelMain.Controls.Add(panelDashboard);
            panelDashboard.Dock = DockStyle.Fill;
            panelDashboard.BringToFront();

            lblTitle.Text = "Menu Principal";
            CargarEstadisticasInventario();
        }

        // Sidebar
        private void btnInicio_Click(object sender, EventArgs e) => VolverAInicio();

        private void lblLogo_Click(object sender, EventArgs e) => VolverAInicio();

        private void panelLogo_Click(object sender, EventArgs e) => VolverAInicio();

        private void btnRemitos_Click(object sender, EventArgs e)
        {
            lblTitle.Text = "Gestión de Remitos";
            OpenChildForm(new FrmGestionRemitos());
        }

        private void btnProveedores_Click(object sender, EventArgs e)
        {
            lblTitle.Text = "Proveedores";
            OpenChildForm(new FrmGestionProveedores());
        }

        private void btnUsuarios_Click(object sender, EventArgs e)
        {
            lblTitle.Text = "Gestión de Usuarios";
            OpenChildForm(new FrmGestionUsuarios());
        }

        private void btnManifiestos_Click(object sender, EventArgs e)
        {
            MessageBox.Show("Funcionalidad… próximamente", "Manifiestos", MessageBoxButtons.OK,
                MessageBoxIcon.Information);
        }

        // Barra superior
        private void btnNotifications_Click(object sender, EventArgs e)
        {
            MessageBox.Show("No hay notificaciones…", "Notificaciones", MessageBoxButtons.OK,
                MessageBoxIcon.Information);
        }

        private void btnProfile_Click(object sender, EventArgs e)
        {
            MessageBox.Show("Configuración de perfil…", "Perfil", MessageBoxButtons.OK,
                MessageBoxIcon.Information);
        }

        private void lblTitle_Click(object sender, EventArgs e)
        {
            // No-op: handler requerido por el Designer
        }

        // Dashboard panels
        private void panelRemitos_Click(object sender, EventArgs e) => btnRemitos_Click(sender, e);
        private void panelManifiestos_Click(object sender, EventArgs e) => btnManifiestos_Click(sender, e);

        // Menú idioma (FASE 1: no aplicar runtime)
        private void menuEspañol_Click(object sender, EventArgs e)
        {
            try
            {
                LoggerService.WriteLog("Idioma seleccionado (sin aplicar en FASE 1): Español",
                    System.Diagnostics.TraceLevel.Info);
            }
            catch (Exception ex)
            {
                LoggerService.WriteException(ex);
            }
        }

        private void menuIngles_Click(object sender, EventArgs e)
        {
            try
            {
                LoggerService.WriteLog("Idioma seleccionado (sin aplicar en FASE 1): Inglés",
                    System.Diagnostics.TraceLevel.Info);
            }
            catch (Exception ex)
            {
                LoggerService.WriteException(ex);
            }
        }

        // Timer
        private void InicializarTimerActualizacion()
        {
            try
            {
                timerActualizacion = new System.Windows.Forms.Timer();
                timerActualizacion.Interval = 300000; // 5 min
                timerActualizacion.Tick += TimerActualizacion_Tick;
                timerActualizacion.Start();
            }
            catch (Exception ex)
            {
                LoggerService.WriteException(ex);
            }
        }

        private void TimerActualizacion_Tick(object sender, EventArgs e)
        {
            try
            {
                if (activeForm == null && panelDashboard != null && panelDashboard.Visible)
                {
                    CargarEstadisticasInventario();
                }
            }
            catch (Exception ex)
            {
                LoggerService.WriteException(ex);
            }
        }

        // Estadísticas
        private void CargarEstadisticasInventario()
        {
            try
            {
                var inventarioService = new InventarioService();
                var estadisticas = inventarioService.ObtenerEstadisticas();

                if (lblStockAceite != null)
                    lblStockAceite.Text = $"{estadisticas.StockTotalAceite:N2} L";

                if (lblStockGrasa != null)
                    lblStockGrasa.Text = $"{estadisticas.StockTotalGrasa:N2} Kg";

                if (lblStockTotal != null)
                    lblStockTotal.Text = $"{estadisticas.StockTotal:N2} L/Kg";

                if (lblEntradasMes != null)
                    lblEntradasMes.Text = $"📥 Entradas (último mes): {estadisticas.EntradasUltimoMes}";

                if (lblSalidasMes != null)
                    lblSalidasMes.Text = $"📤 Salidas (último mes): {estadisticas.SalidasUltimoMes}";

                if (lblUltimaActualizacion != null)
                    lblUltimaActualizacion.Text =
                        $"Última actualización: {estadisticas.FechaActualizacion:dd/MM/yyyy HH:mm}";
            }
            catch (Exception ex)
            {
                if (lblStockAceite != null) lblStockAceite.Text = "Error";
                if (lblStockGrasa != null) lblStockGrasa.Text = "Error";
                if (lblStockTotal != null) lblStockTotal.Text = "Error";
                if (lblEntradasMes != null) lblEntradasMes.Text = "Error";
                if (lblSalidasMes != null) lblSalidasMes.Text = "Error";
                if (lblUltimaActualizacion != null) lblUltimaActualizacion.Text = "Error";

                LoggerService.WriteException(ex);
            }
        }

        // Métodos públicos útiles
        public void RefrescarEstadisticas() => CargarEstadisticasInventario();

        public void PausarActualizacionAutomatica()
        {
            if (timerActualizacion != null)
                timerActualizacion.Stop();
        }

        public void ReanudarActualizacionAutomatica()
        {
            if (timerActualizacion != null)
                timerActualizacion.Start();
        }

        protected override void OnFormClosed(FormClosedEventArgs e)
        {
            try
            {
                if (timerActualizacion != null)
                {
                    timerActualizacion.Stop();
                    timerActualizacion.Tick -= TimerActualizacion_Tick;
                    timerActualizacion.Dispose();
                    timerActualizacion = null;
                }

                if (activeForm != null)
                {
                    activeForm.Dispose();
                    activeForm = null;
                }
            }
            catch
            {
                // ignore
            }

            base.OnFormClosed(e);
        }
    }
}
