using SERVICES.Dominio;
using SERVICES.DTO;
using SERVICES.Logic;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace SERVICES.Facade
{
    /// <summary>
    /// Servicio de fachada para operaciones relacionadas con usuarios,
    /// como autenticación, registro, acceso, recuperación de contraseña y asignación de permisos.
    /// </summary>
    public static class UserService
    {
        private static UserLogic _userLogic = new UserLogic();

        /// <summary>
        /// Verifica las credenciales del usuario para iniciar sesión.
        /// </summary>
        /// <param name="username">Nombre de usuario.</param>
        /// <param name="password">Contraseña en texto plano.</param>
        /// <returns>True si las credenciales son válidas, false en caso contrario.</returns>
        public static bool Login(string username, string password)
        {
            return _userLogic.ValidateUser(username, password);
        }

        /// <summary>
        /// Registra un nuevo usuario en el sistema.
        /// </summary>
        /// <param name="username">Nombre de usuario.</param>
        /// <param name="password">Contraseña.</param>
        /// <param name="telefono">Número de teléfono del usuario.</param>
        public static void Register(string username, string password, string telefono)
        {
            var usuario = new Usuario
            {
                UserName = username,
                Telefono = telefono
            };
            _userLogic.CreateUser(usuario, password);
        }

        /// <summary>
        /// Registra un nuevo usuario en el sistema con todos los datos.
        /// </summary>
        /// <param name="usuario">Objeto Usuario con todos los datos.</param>
        /// <param name="password">Contraseña en texto plano.</param>
        public static void RegisterUsuario(Usuario usuario, string password)
        {
            _userLogic.CreateUser(usuario, password);
        }

        /// <summary>
        /// Actualiza los datos de un usuario existente.
        /// </summary>
        /// <param name="usuario">Usuario con los datos actualizados.</param>
        public static void UpdateUsuario(Usuario usuario)
        {
            _userLogic.UpdateUsuario(usuario);
        }

        /// <summary>
        /// Obtiene un usuario por su ID.
        /// </summary>
        /// <param name="idUsuario">ID del usuario.</param>
        /// <returns>Usuario encontrado o null si no existe.</returns>
        public static Usuario GetUsuarioById(Guid idUsuario)
        {
            return _userLogic.GetUsuarioById(idUsuario);
        }

        /// <summary>
        /// Obtiene todos los usuarios activos del sistema.
        /// </summary>
        /// <returns>Lista de usuarios activos.</returns>
        public static List<Usuario> GetUsuariosActivos()
        {
            return _userLogic.GetUsuariosActivos();
        }

        /// <summary>
        /// Crea una nueva patente (permiso) en el sistema.
        /// </summary>
        /// <param name="patente">Objeto <see cref="Patente"/> con los datos del permiso.</param>
        public static void CreatePatente(Patente patente)
        {
            _userLogic.CreatePatente(patente);
        }

        /// <summary>
        /// Desactiva un usuario del sistema (soft delete).
        /// </summary>
        /// <param name="idUsuario">ID del usuario a desactivar.</param>
        public static void DisableUser(Guid idUsuario)
        {
            _userLogic.DisableUser(idUsuario);
        }

        /// <summary>
        /// Habilita nuevamente un usuario previamente desactivado.
        /// </summary>
        /// <param name="idUsuario">ID del usuario a habilitar.</param>
        public static void EnabledUsuario(Guid idUsuario)
        {
            _userLogic.EnabledUsuario(idUsuario);
        }

        /// <summary>
        /// Actualiza los accesos (familias y patentes) asignados a un usuario.
        /// </summary>
        /// <param name="idUsuario">ID del usuario.</param>
        /// <param name="accesos">Lista de accesos a asignar.</param>
        public static void UpdateUserAccesos(Guid idUsuario, List<Acceso> accesos)
        {
            _userLogic.UpdateUserAccesos(idUsuario, accesos);
        }

        /// <summary>
        /// Obtiene la lista completa de usuarios registrados.
        /// </summary>
        /// <returns>Lista de objetos <see cref="Usuario"/>.</returns>
        public static List<Usuario> GetAllUsuarios()
        {
            return _userLogic.GetAllUsuarios();
        }

        /// <summary>
        /// Obtiene un usuario por su nombre de usuario.
        /// </summary>
        /// <param name="username">Nombre de usuario a buscar.</param>
        /// <returns>Objeto <see cref="Usuario"/> correspondiente, o null si no existe.</returns>
        public static Usuario GetUsuarioByUsername(string username)
        {
            return _userLogic.GetUsuarioByUsername(username);
        }

        /// <summary>
        /// Obtiene una lista de usuarios junto con sus familias asignadas.
        /// </summary>
        /// <returns>Lista de <see cref="UsuarioFamiliaDto"/>.</returns>
        public static List<UsuarioFamiliaDto> GetUsuariosConFamilias()
        {
            return _userLogic.GetUsuariosConFamilias();
        }

        /// <summary>
        /// Inicia el proceso de recuperación de contraseña para un usuario,
        /// enviando un código OTP por SMS.
        /// </summary>
        /// <param name="username">Nombre de usuario.</param>
        public static void StartPasswordRecovery(string username)
        {
            _userLogic.StartPasswordRecovery(username);
        }

        /// <summary>
        /// Valida el código OTP ingresado por el usuario.
        /// </summary>
        /// <param name="username">Nombre de usuario.</param>
        /// <param name="otp">Código OTP recibido por el usuario.</param>
        /// <returns>True si el código es válido, false en caso contrario.</returns>
        public static bool ValidateOTP(string username, string otp)
        {
            return _userLogic.ValidateOTP(username, otp);
        }

        /// <summary>
        /// Cambia la contraseña del usuario luego de una recuperación exitosa.
        /// </summary>
        /// <param name="username">Nombre de usuario.</param>
        /// <param name="newPassword">Nueva contraseña.</param>
        public static void ChangePassword(string username, string newPassword)
        {
            _userLogic.ChangePassword(username, newPassword);
        }

        // ===== GESTIÓN DE FAMILIAS =====

        /// <summary>
        /// Asigna una familia a un usuario.
        /// </summary>
        /// <param name="idUsuario">ID del usuario.</param>
        /// <param name="idFamilia">ID de la familia.</param>
        public static void AsignarFamiliaAUsuario(Guid idUsuario, Guid idFamilia)
        {
            _userLogic.AsignarFamiliaAUsuario(idUsuario, idFamilia);
        }

        /// <summary>
        /// Remueve una familia de un usuario.
        /// </summary>
        /// <param name="idUsuario">ID del usuario.</param>
        /// <param name="idFamilia">ID de la familia.</param>
        public static void RemoverFamiliaDeUsuario(Guid idUsuario, Guid idFamilia)
        {
            _userLogic.RemoverFamiliaDeUsuario(idUsuario, idFamilia);
        }

        /// <summary>
        /// Obtiene las familias asignadas a un usuario.
        /// </summary>
        /// <param name="idUsuario">ID del usuario.</param>
        /// <returns>Lista de familias.</returns>
        public static List<Familia> GetFamiliasByUsuario(Guid idUsuario)
        {
            return _userLogic.GetFamiliasByUsuario(idUsuario);
        }

        // ===== GESTIÓN DE PATENTES =====

        /// <summary>
        /// Asigna una patente a un usuario.
        /// </summary>
        /// <param name="idUsuario">ID del usuario.</param>
        /// <param name="idPatente">ID de la patente.</param>
        public static void AsignarPatenteAUsuario(Guid idUsuario, Guid idPatente)
        {
            _userLogic.AsignarPatenteAUsuario(idUsuario, idPatente);
        }

        /// <summary>
        /// Remueve una patente de un usuario.
        /// </summary>
        /// <param name="idUsuario">ID del usuario.</param>
        /// <param name="idPatente">ID de la patente.</param>
        public static void RemoverPatenteDeUsuario(Guid idUsuario, Guid idPatente)
        {
            _userLogic.RemoverPatenteDeUsuario(idUsuario, idPatente);
        }

        /// <summary>
        /// Obtiene las patentes asignadas directamente a un usuario.
        /// </summary>
        /// <param name="idUsuario">ID del usuario.</param>
        /// <returns>Lista de patentes.</returns>
        public static List<Patente> GetPatentesByUsuario(Guid idUsuario)
        {
            return _userLogic.GetPatentesByUsuario(idUsuario);
        }

        // ===== UTILIDADES =====

        /// <summary>
        /// Obtiene todas las familias disponibles en el sistema.
        /// </summary>
        /// <returns>Lista de todas las familias.</returns>
        public static List<Familia> GetAllFamilias()
        {
            return FamiliaService.GetAllFamilias();
        }

        /// <summary>
        /// Obtiene todas las patentes disponibles en el sistema.
        /// </summary>
        /// <returns>Lista de todas las patentes.</returns>
        public static List<Patente> GetAllPatentes()
        {
            return FamiliaService.GetAllPatentes();
        }
    }
}
