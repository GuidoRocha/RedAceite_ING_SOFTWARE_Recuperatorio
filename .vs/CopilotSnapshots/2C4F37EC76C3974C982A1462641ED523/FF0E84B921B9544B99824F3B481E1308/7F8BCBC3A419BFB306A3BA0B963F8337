using SERVICES.DAL.Contratos;
using SERVICES.DAL.Implementaciones.SQL.Helpers;
using SERVICES.Dominio;
using SERVICES.DTO;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using static SERVICES.Dominio.Usuario;

namespace SERVICES.DAL.Implementaciones.SQL
{
    public class UsuarioRepository : IUsuarioDAL
    {
        private readonly FamiliaRepository _familiaRepository;

        public UsuarioRepository()
        {
            _familiaRepository = new FamiliaRepository();
        }

        public Usuario GetUsuarioByUsername(string username)
        {
            Usuario usuario = null;

            using (SqlDataReader reader = SqlHelper.ExecuteReader(
                "SELECT IdUsuario, UserName, Password, Estado, Telefono, Nombre, Apellido, Email, DNI FROM Usuario WHERE UPPER(UserName) = UPPER(@UserName)",
                CommandType.Text,
                new SqlParameter("@UserName", username)))
            {
                if (reader.Read())
                {
                    usuario = new Usuario
                    {
                        IdUsuario = reader.GetGuid(0),
                        UserName = reader.GetString(1),
                        Password = reader.GetString(2),
                        Estado = reader.GetString(3),
                        Telefono = reader.IsDBNull(4) ? null : reader.GetString(4),
                        Nombre = reader.IsDBNull(5) ? null : reader.GetString(5),
                        Apellido = reader.IsDBNull(6) ? null : reader.GetString(6),
                        Email = reader.IsDBNull(7) ? null : reader.GetString(7),
                        DNI = reader.IsDBNull(8) ? null : reader.GetString(8)
                    };
                }
            }

            if (usuario != null)
            {
                // Obtener las familias del usuario
                List<Familia> familias = GetFamiliasByUsuarioId(usuario.IdUsuario);
                usuario.Accesos.AddRange(familias);
            }

            return usuario;
        }

        public Usuario GetUsuarioById(Guid idUsuario)
        {
            Usuario usuario = null;

            using (SqlDataReader reader = SqlHelper.ExecuteReader(
                "SELECT IdUsuario, UserName, Password, Estado, Telefono, Nombre, Apellido, Email, DNI FROM Usuario WHERE IdUsuario = @IdUsuario",
                CommandType.Text,
                new SqlParameter("@IdUsuario", idUsuario)))
            {
                if (reader.Read())
                {
                    usuario = new Usuario
                    {
                        IdUsuario = reader.GetGuid(0),
                        UserName = reader.GetString(1),
                        Password = reader.GetString(2),
                        Estado = reader.GetString(3),
                        Telefono = reader.IsDBNull(4) ? null : reader.GetString(4),
                        Nombre = reader.IsDBNull(5) ? null : reader.GetString(5),
                        Apellido = reader.IsDBNull(6) ? null : reader.GetString(6),
                        Email = reader.IsDBNull(7) ? null : reader.GetString(7),
                        DNI = reader.IsDBNull(8) ? null : reader.GetString(8)
                    };
                }
            }

            if (usuario != null)
            {
                // Obtener las familias y patentes del usuario
                usuario.Accesos.AddRange(GetFamiliasByUsuarioId(usuario.IdUsuario));
                usuario.Accesos.AddRange(GetPatentesByUsuarioId(usuario.IdUsuario));
            }

            return usuario;
        }

        public List<Familia> GetFamiliasByUsuarioId(Guid usuarioId)
        {
            List<Familia> familias = new List<Familia>();

            using (SqlDataReader reader = SqlHelper.ExecuteReader(
                "SELECT f.IdFamilia, f.Nombre FROM Familia f " +
                "INNER JOIN Usuario_Familia uf ON f.IdFamilia = uf.IdFamilia " +
                "WHERE uf.IdUsuario = @IdUsuario",
                CommandType.Text,
                new SqlParameter("@IdUsuario", usuarioId)))
            {
                while (reader.Read())
                {
                    var familia = new Familia
                    {
                        Id = reader.GetGuid(0),
                        Nombre = reader.GetString(1)
                    };

                    // Obtener las patentes asociadas a esta familia
                    familia.Accesos.AddRange(_familiaRepository.GetPatentesByFamiliaId(familia.Id));

                    // Añadir la familia a la lista
                    familias.Add(familia);
                }
            }

            return familias;
        }

        public List<Patente> GetPatentesByUsuarioId(Guid idUsuario)
        {
            List<Patente> patentes = new List<Patente>();

            using (SqlDataReader reader = SqlHelper.ExecuteReader(
                "SELECT p.IdPatente, p.Nombre, p.DataKey FROM Patente p " +
                "INNER JOIN Usuario_Patente up ON p.IdPatente = up.IdPatente " +
                "WHERE up.IdUsuario = @IdUsuario",
                CommandType.Text,
                new SqlParameter("@IdUsuario", idUsuario)))
            {
                while (reader.Read())
                {
                    patentes.Add(new Patente
                    {
                        Id = reader.GetGuid(0),
                        Nombre = reader.GetString(1),
                        DataKey = reader.GetString(2)
                    });
                }
            }

            return patentes;
        }

        public void CreateUsuario(Usuario usuario)
        {
            SqlHelper.ExecuteNonQuery(
                "INSERT INTO Usuario (IdUsuario, UserName, Password, Estado, Telefono, Nombre, Apellido, Email, DNI) " +
                "VALUES (@IdUsuario, @UserName, @Password, @Estado, @Telefono, @Nombre, @Apellido, @Email, @DNI)",
                CommandType.Text,
                new SqlParameter("@IdUsuario", usuario.IdUsuario),
                new SqlParameter("@UserName", usuario.UserName),
                new SqlParameter("@Password", usuario.Password),
                new SqlParameter("@Estado", (int)EstadoUsuario.Habilitado),
                new SqlParameter("@Telefono", usuario.Telefono ?? (object)DBNull.Value),
                new SqlParameter("@Nombre", usuario.Nombre ?? (object)DBNull.Value),
                new SqlParameter("@Apellido", usuario.Apellido ?? (object)DBNull.Value),
                new SqlParameter("@Email", usuario.Email ?? (object)DBNull.Value),
                new SqlParameter("@DNI", usuario.DNI ?? (object)DBNull.Value)
            );
        }

        public void UpdateUsuario(Usuario usuario)
        {
            SqlHelper.ExecuteNonQuery(
                "UPDATE Usuario SET " +
                "Telefono = @Telefono, " +
                "Nombre = @Nombre, " +
                "Apellido = @Apellido, " +
                "Email = @Email " +
                "WHERE IdUsuario = @IdUsuario",
                CommandType.Text,
                new SqlParameter("@IdUsuario", usuario.IdUsuario),
                new SqlParameter("@Telefono", usuario.Telefono ?? (object)DBNull.Value),
                new SqlParameter("@Nombre", usuario.Nombre ?? (object)DBNull.Value),
                new SqlParameter("@Apellido", usuario.Apellido ?? (object)DBNull.Value),
                new SqlParameter("@Email", usuario.Email ?? (object)DBNull.Value)
            );
        }

        public void DisableUsuario(Guid idUsuario)
        {
            SqlHelper.ExecuteNonQuery(
                "UPDATE Usuario SET Estado = '0' WHERE IdUsuario = @IdUsuario",
                CommandType.Text,
                new SqlParameter("@IdUsuario", idUsuario)
            );
        }

        public void EnabledUsuario(Guid idUsuario)
        {
            SqlHelper.ExecuteNonQuery(
                "UPDATE Usuario SET Estado = '1' WHERE IdUsuario = @IdUsuario",
                CommandType.Text,
                new SqlParameter("@IdUsuario", idUsuario)
            );
        }

        public List<Usuario> GetUsuariosActivos()
        {
            List<Usuario> usuarios = new List<Usuario>();

            using (SqlDataReader reader = SqlHelper.ExecuteReader(
                "SELECT IdUsuario, UserName, Estado, Telefono, Nombre, Apellido, Email, DNI " +
                "FROM Usuario WHERE Estado = '1' ORDER BY UserName",
                CommandType.Text))
            {
                while (reader.Read())
                {
                    usuarios.Add(new Usuario
                    {
                        IdUsuario = reader.GetGuid(0),
                        UserName = reader.GetString(1),
                        Estado = reader.GetString(2),
                        Telefono = reader.IsDBNull(3) ? null : reader.GetString(3),
                        Nombre = reader.IsDBNull(4) ? null : reader.GetString(4),
                        Apellido = reader.IsDBNull(5) ? null : reader.GetString(5),
                        Email = reader.IsDBNull(6) ? null : reader.GetString(6),
                        DNI = reader.IsDBNull(7) ? null : reader.GetString(7)
                    });
                }
            }

            return usuarios;
        }

        public void UpdateAccesos(Guid idUsuario, List<Acceso> accesos)
        {
            // Primero eliminamos los accesos existentes
            SqlHelper.ExecuteNonQuery(
                "DELETE FROM Usuario_Patente WHERE IdUsuario = @IdUsuario",
                CommandType.Text,
                new SqlParameter("@IdUsuario", idUsuario)
            );

            // Luego insertamos los nuevos accesos
            foreach (var acceso in accesos)
            {
                SqlHelper.ExecuteNonQuery(
                    "INSERT INTO Usuario_Patente (IdUsuario, IdPatente) VALUES (@IdUsuario, @IdPatente)",
                    CommandType.Text,
                    new SqlParameter("@IdUsuario", idUsuario),
                    new SqlParameter("@IdPatente", acceso.Id)
                );
            }
        }

        // ===== GESTIÓN DE FAMILIAS =====

        public void AsignarFamiliaAUsuario(Guid idUsuario, Guid idFamilia)
        {
            SqlHelper.ExecuteNonQuery(
                "IF NOT EXISTS (SELECT 1 FROM Usuario_Familia WHERE IdUsuario = @IdUsuario AND IdFamilia = @IdFamilia) " +
                "INSERT INTO Usuario_Familia (IdUsuario, IdFamilia) VALUES (@IdUsuario, @IdFamilia)",
                CommandType.Text,
                new SqlParameter("@IdUsuario", idUsuario),
                new SqlParameter("@IdFamilia", idFamilia)
            );
        }

        public void RemoverFamiliaDeUsuario(Guid idUsuario, Guid idFamilia)
        {
            SqlHelper.ExecuteNonQuery(
                "DELETE FROM Usuario_Familia WHERE IdUsuario = @IdUsuario AND IdFamilia = @IdFamilia",
                CommandType.Text,
                new SqlParameter("@IdUsuario", idUsuario),
                new SqlParameter("@IdFamilia", idFamilia)
            );
        }

        // ===== GESTIÓN DE PATENTES =====

        public void AsignarPatenteAUsuario(Guid idUsuario, Guid idPatente)
        {
            SqlHelper.ExecuteNonQuery(
                "IF NOT EXISTS (SELECT 1 FROM Usuario_Patente WHERE IdUsuario = @IdUsuario AND IdPatente = @IdPatente) " +
                "INSERT INTO Usuario_Patente (IdUsuario, IdPatente) VALUES (@IdUsuario, @IdPatente)",
                CommandType.Text,
                new SqlParameter("@IdUsuario", idUsuario),
                new SqlParameter("@IdPatente", idPatente)
            );
        }

        public void RemoverPatenteDeUsuario(Guid idUsuario, Guid idPatente)
        {
            SqlHelper.ExecuteNonQuery(
                "DELETE FROM Usuario_Patente WHERE IdUsuario = @IdUsuario AND IdPatente = @IdPatente",
                CommandType.Text,
                new SqlParameter("@IdUsuario", idUsuario),
                new SqlParameter("@IdPatente", idPatente)
            );
        }

        // ===== VALIDACIONES =====

        public bool ExisteUsuarioPorUsername(string username)
        {
            using (SqlDataReader reader = SqlHelper.ExecuteReader(
                "SELECT COUNT(*) FROM Usuario WHERE UPPER(UserName) = UPPER(@UserName)",
                CommandType.Text,
                new SqlParameter("@UserName", username)))
            {
                if (reader.Read())
                {
                    return reader.GetInt32(0) > 0;
                }
            }
            return false;
        }

        public bool ExisteUsuarioPorDNI(string dni)
        {
            if (string.IsNullOrWhiteSpace(dni))
                return false;

            using (SqlDataReader reader = SqlHelper.ExecuteReader(
                "SELECT COUNT(*) FROM Usuario WHERE DNI = @DNI",
                CommandType.Text,
                new SqlParameter("@DNI", dni)))
            {
                if (reader.Read())
                {
                    return reader.GetInt32(0) > 0;
                }
            }
            return false;
        }

        // ===== MÉTODOS EXISTENTES (OTP, Password, etc.) =====

        public void SetOTP(Guid idUsuario, string otp, DateTime expiry)
        {
            SqlHelper.ExecuteNonQuery(
                "UPDATE Usuario SET OTP = @OTP, OTPExpiry = @OTPExpiry WHERE IdUsuario = @IdUsuario",
                CommandType.Text,
                new SqlParameter("@OTP", otp),
                new SqlParameter("@OTPExpiry", expiry),
                new SqlParameter("@IdUsuario", idUsuario)
            );
        }

        public Usuario GetUsuarioByUsernameWithOTP(string username)
        {
            Usuario usuario = null;

            using (SqlDataReader reader = SqlHelper.ExecuteReader(
                "SELECT IdUsuario, UserName, Password, Estado, OTP, OTPExpiry FROM Usuario WHERE UserName = @UserName",
                CommandType.Text,
                new SqlParameter("@UserName", username)))
            {
                if (reader.Read())
                {
                    usuario = new Usuario
                    {
                        IdUsuario = reader.GetGuid(0),
                        UserName = reader.GetString(1),
                        Password = reader.GetString(2),
                        Estado = reader.GetString(3),
                        OTP = reader.IsDBNull(4) ? null : reader.GetString(4),
                        OTPExpiry = reader.IsDBNull(5) ? (DateTime?)null : reader.GetDateTime(5)
                    };
                }
            }

            return usuario;
        }

        public void UpdatePassword(Guid idUsuario, string newPassword)
        {
            SqlHelper.ExecuteNonQuery(
                "UPDATE Usuario SET Password = @Password, OTP = NULL, OTPExpiry = NULL WHERE IdUsuario = @IdUsuario",
                CommandType.Text,
                new SqlParameter("@Password", newPassword),
                new SqlParameter("@IdUsuario", idUsuario)
            );
        }

        public List<Usuario> GetAll()
        {
            List<Usuario> usuarios = new List<Usuario>();

            string query = "SELECT IdUsuario, UserName, Estado, Telefono, Nombre, Apellido, Email, DNI FROM Usuario ORDER BY UserName";

            using (SqlDataReader reader = SqlHelper.ExecuteReader(query, CommandType.Text))
            {
                while (reader.Read())
                {
                    usuarios.Add(new Usuario
                    {
                        IdUsuario = reader.GetGuid(0),
                        UserName = reader.GetString(1),
                        Estado = reader.GetString(2),
                        Telefono = reader.IsDBNull(3) ? null : reader.GetString(3),
                        Nombre = reader.IsDBNull(4) ? null : reader.GetString(4),
                        Apellido = reader.IsDBNull(5) ? null : reader.GetString(5),
                        Email = reader.IsDBNull(6) ? null : reader.GetString(6),
                        DNI = reader.IsDBNull(7) ? null : reader.GetString(7)
                    });
                }
            }

            return usuarios;
        }

        public List<UsuarioFamiliaDto> GetUsuariosConFamilias()
        {
            string query = @"
            SELECT 
                u.UserName AS Usuario,
                f.Nombre AS Familia,
                u.Estado AS Estado
            FROM 
                Usuario u
            LEFT JOIN 
                Usuario_Familia uf ON u.IdUsuario = uf.IdUsuario
            LEFT JOIN 
                Familia f ON uf.IdFamilia = f.IdFamilia";

            List<UsuarioFamiliaDto> usuariosFamilias = new List<UsuarioFamiliaDto>();

            using (var reader = SqlHelper.ExecuteReader(query, CommandType.Text))
            {
                while (reader.Read())
                {
                    usuariosFamilias.Add(new UsuarioFamiliaDto
                    {
                        Usuario = reader.GetString(0),
                        Familia = reader.IsDBNull(1) ? "Sin familia" : reader.GetString(1),
                        Estado = reader.GetString(2)
                    });
                }
            }

            return usuariosFamilias;
        }

        public void CreatePatente(Patente patente)
        {
            SqlHelper.ExecuteNonQuery(
                "INSERT INTO Patente (IdPatente, Nombre, DataKey) VALUES (@IdPatente, @Nombre, @DataKey)",
                CommandType.Text,
                new SqlParameter("@IdPatente", patente.Id),
                new SqlParameter("@Nombre", patente.Nombre),
                new SqlParameter("@DataKey", patente.DataKey)
            );
        }

        public void Add(Usuario obj)
        {
            CreateUsuario(obj);
        }

        public void Update(Usuario obj)
        {
            UpdateUsuario(obj);
        }

        public void Remove(Guid id)
        {
            DisableUsuario(id);
        }

        public Usuario GetById(Guid id)
        {
            return GetUsuarioById(id);
        }
    }
}
