using SERVICES.DAL.Contratos;
using SERVICES.DAL.Implementaciones.SQL.Helpers;
using SERVICES.Dominio;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace SERVICES.DAL.Implementaciones.SQL
{
    /// <summary>
    /// Implementación del repositorio de acceso a datos para la entidad Remito.
    /// Utiliza SQL Server como backend de almacenamiento.
    /// </summary>
    public class RemitoRepository : IRemitoDAL
    {
        /// <summary>
        /// Constructor por defecto del repositorio de remitos.
        /// </summary>
        public RemitoRepository()
        {
        }

        #region Métodos específicos de IRemitoDAL

        /// <summary>
        /// Crea un nuevo remito en la base de datos.
        /// </summary>
        /// <param name="remito">El remito a crear.</param>
        public void CreateRemito(Remito remito)
        {
            string query = @"INSERT INTO Remito 
                            (IdRemito, NombreTransportista, DomicilioTransportista, NombreGenerador, 
                             DomicilioPlanta, TipoResiduo, Cantidad, Estado, Cuit, NombreFantasia, 
                             Direccion, FechaCreacion, EstadoRemito)
                            VALUES 
                            (@IdRemito, @NombreTransportista, @DomicilioTransportista, @NombreGenerador, 
                             @DomicilioPlanta, @TipoResiduo, @Cantidad, @Estado, @Cuit, @NombreFantasia, 
                             @Direccion, @FechaCreacion, @EstadoRemito)";

            SqlHelper.ExecuteNonQuery(query, CommandType.Text,
                new SqlParameter("@IdRemito", remito.IdRemito),
                new SqlParameter("@NombreTransportista", remito.NombreTransportista),
                new SqlParameter("@DomicilioTransportista", remito.DomicilioTransportista),
                new SqlParameter("@NombreGenerador", remito.NombreGenerador),
                new SqlParameter("@DomicilioPlanta", remito.DomicilioPlanta),
                new SqlParameter("@TipoResiduo", remito.TipoResiduo),
                new SqlParameter("@Cantidad", remito.Cantidad),
                new SqlParameter("@Estado", remito.Estado),
                new SqlParameter("@Cuit", remito.Cuit),
                new SqlParameter("@NombreFantasia", remito.NombreFantasia),
                new SqlParameter("@Direccion", remito.Direccion),
                new SqlParameter("@FechaCreacion", remito.FechaCreacion),
                new SqlParameter("@EstadoRemito", remito.EstadoRemito)
            );
        }

        /// <summary>
        /// Obtiene un remito por su identificador único.
        /// </summary>
        /// <param name="idRemito">El ID del remito.</param>
        /// <returns>El remito correspondiente, si existe.</returns>
        public Remito GetRemitoById(Guid idRemito)
        {
            Remito remito = null;

            string query = @"SELECT IdRemito, NombreTransportista, DomicilioTransportista, NombreGenerador, 
                                    DomicilioPlanta, TipoResiduo, Cantidad, Estado, Cuit, NombreFantasia, 
                                    Direccion, FechaCreacion, EstadoRemito
                             FROM Remito 
                             WHERE IdRemito = @IdRemito";

            using (SqlDataReader reader = SqlHelper.ExecuteReader(query, CommandType.Text,
                new SqlParameter("@IdRemito", idRemito)))
            {
                if (reader.Read())
                {
                    remito = MapearRemito(reader);
                }
            }

            return remito;
        }

        /// <summary>
        /// Obtiene todos los remitos registrados en el sistema.
        /// </summary>
        /// <returns>Una lista de todos los remitos.</returns>
        public List<Remito> GetAllRemitos()
        {
            List<Remito> remitos = new List<Remito>();

            string query = @"SELECT IdRemito, NombreTransportista, DomicilioTransportista, NombreGenerador, 
                                    DomicilioPlanta, TipoResiduo, Cantidad, Estado, Cuit, NombreFantasia, 
                                    Direccion, FechaCreacion, EstadoRemito
                             FROM Remito
                             ORDER BY FechaCreacion DESC";

            using (SqlDataReader reader = SqlHelper.ExecuteReader(query, CommandType.Text))
            {
                while (reader.Read())
                {
                    remitos.Add(MapearRemito(reader));
                }
            }

            return remitos;
        }

        /// <summary>
        /// Obtiene los remitos filtrados por CUIT del generador.
        /// </summary>
        /// <param name="cuit">El CUIT del generador.</param>
        /// <returns>Una lista de remitos asociados al CUIT especificado.</returns>
        public List<Remito> GetRemitosByCuit(string cuit)
        {
            List<Remito> remitos = new List<Remito>();

            string query = @"SELECT IdRemito, NombreTransportista, DomicilioTransportista, NombreGenerador, 
                                    DomicilioPlanta, TipoResiduo, Cantidad, Estado, Cuit, NombreFantasia, 
                                    Direccion, FechaCreacion, EstadoRemito
                             FROM Remito 
                             WHERE Cuit = @Cuit
                             ORDER BY FechaCreacion DESC";

            using (SqlDataReader reader = SqlHelper.ExecuteReader(query, CommandType.Text,
                new SqlParameter("@Cuit", cuit)))
            {
                while (reader.Read())
                {
                    remitos.Add(MapearRemito(reader));
                }
            }

            return remitos;
        }

        /// <summary>
        /// Obtiene los remitos creados en un rango de fechas.
        /// </summary>
        /// <param name="fechaInicio">Fecha de inicio del rango.</param>
        /// <param name="fechaFin">Fecha de fin del rango.</param>
        /// <returns>Una lista de remitos dentro del rango de fechas.</returns>
        public List<Remito> GetRemitosByFechaRango(DateTime fechaInicio, DateTime fechaFin)
        {
            List<Remito> remitos = new List<Remito>();

            string query = @"SELECT IdRemito, NombreTransportista, DomicilioTransportista, NombreGenerador, 
                                    DomicilioPlanta, TipoResiduo, Cantidad, Estado, Cuit, NombreFantasia, 
                                    Direccion, FechaCreacion, EstadoRemito
                             FROM Remito 
                             WHERE FechaCreacion BETWEEN @FechaInicio AND @FechaFin
                             ORDER BY FechaCreacion DESC";

            using (SqlDataReader reader = SqlHelper.ExecuteReader(query, CommandType.Text,
                new SqlParameter("@FechaInicio", fechaInicio),
                new SqlParameter("@FechaFin", fechaFin)))
            {
                while (reader.Read())
                {
                    remitos.Add(MapearRemito(reader));
                }
            }

            return remitos;
        }

        /// <summary>
        /// Anula un remito existente (soft delete).
        /// </summary>
        /// <param name="idRemito">El ID del remito a anular.</param>
        public void AnularRemito(Guid idRemito)
        {
            string query = "UPDATE Remito SET EstadoRemito = 'Anulado' WHERE IdRemito = @IdRemito";

            SqlHelper.ExecuteNonQuery(query, CommandType.Text,
                new SqlParameter("@IdRemito", idRemito));
        }

        #endregion

        #region Métodos de IGenericServiceDAL<Remito>

        /// <summary>
        /// Agrega un nuevo remito (implementación de IGenericServiceDAL).
        /// </summary>
        /// <param name="obj">El remito a agregar.</param>
        public void Add(Remito obj)
        {
            CreateRemito(obj);
        }

        /// <summary>
        /// Actualiza un remito existente.
        /// </summary>
        /// <param name="obj">El remito con los datos actualizados.</param>
        public void Update(Remito obj)
        {
            string query = @"UPDATE Remito 
                            SET NombreTransportista = @NombreTransportista,
                                DomicilioTransportista = @DomicilioTransportista,
                                NombreGenerador = @NombreGenerador,
                                DomicilioPlanta = @DomicilioPlanta,
                                TipoResiduo = @TipoResiduo,
                                Cantidad = @Cantidad,
                                Estado = @Estado,
                                Cuit = @Cuit,
                                NombreFantasia = @NombreFantasia,
                                Direccion = @Direccion,
                                EstadoRemito = @EstadoRemito
                            WHERE IdRemito = @IdRemito";

            SqlHelper.ExecuteNonQuery(query, CommandType.Text,
                new SqlParameter("@IdRemito", obj.IdRemito),
                new SqlParameter("@NombreTransportista", obj.NombreTransportista),
                new SqlParameter("@DomicilioTransportista", obj.DomicilioTransportista),
                new SqlParameter("@NombreGenerador", obj.NombreGenerador),
                new SqlParameter("@DomicilioPlanta", obj.DomicilioPlanta),
                new SqlParameter("@TipoResiduo", obj.TipoResiduo),
                new SqlParameter("@Cantidad", obj.Cantidad),
                new SqlParameter("@Estado", obj.Estado),
                new SqlParameter("@Cuit", obj.Cuit),
                new SqlParameter("@NombreFantasia", obj.NombreFantasia),
                new SqlParameter("@Direccion", obj.Direccion),
                new SqlParameter("@EstadoRemito", obj.EstadoRemito)
            );
        }

        /// <summary>
        /// Elimina un remito por su ID (hard delete).
        /// </summary>
        /// <param name="id">El ID del remito a eliminar.</param>
        public void Remove(Guid id)
        {
            string query = "DELETE FROM Remito WHERE IdRemito = @IdRemito";

            SqlHelper.ExecuteNonQuery(query, CommandType.Text,
                new SqlParameter("@IdRemito", id));
        }

        /// <summary>
        /// Obtiene un remito por su ID (implementación de IGenericServiceDAL).
        /// </summary>
        /// <param name="id">El ID del remito.</param>
        /// <returns>El remito correspondiente.</returns>
        public Remito GetById(Guid id)
        {
            return GetRemitoById(id);
        }

        /// <summary>
        /// Obtiene todos los remitos (implementación de IGenericServiceDAL).
        /// </summary>
        /// <returns>Una lista de todos los remitos.</returns>
        public List<Remito> GetAll()
        {
            return GetAllRemitos();
        }

        #endregion

        #region Métodos auxiliares

        /// <summary>
        /// Mapea un SqlDataReader a un objeto Remito.
        /// </summary>
        /// <param name="reader">El SqlDataReader con los datos del remito.</param>
        /// <returns>Un objeto Remito mapeado.</returns>
        private Remito MapearRemito(SqlDataReader reader)
        {
            return new Remito
            {
                IdRemito = reader.GetGuid(0),
                NombreTransportista = reader.GetString(1),
                DomicilioTransportista = reader.GetString(2),
                NombreGenerador = reader.GetString(3),
                DomicilioPlanta = reader.GetString(4),
                TipoResiduo = reader.GetString(5),
                Cantidad = reader.GetDecimal(6),
                Estado = reader.GetString(7),
                Cuit = reader.GetString(8),
                NombreFantasia = reader.GetString(9),
                Direccion = reader.GetString(10),
                FechaCreacion = reader.GetDateTime(11),
                EstadoRemito = reader.GetString(12)
            };
        }

        #endregion
    }
}
