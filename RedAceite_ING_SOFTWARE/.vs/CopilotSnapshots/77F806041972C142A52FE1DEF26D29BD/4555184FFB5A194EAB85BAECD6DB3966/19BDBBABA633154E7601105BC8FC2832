using SERVICES.Facade;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace RedAceite_ING_SOFTWARE.Forms
{
    /// <summary>
    /// Formulario para la generación de remitos de recolección de residuos.
    /// Permite ingresar los datos del generador y los detalles del residuo a recolectar.
    /// </summary>
    public partial class FrmGenerarRemito : Form
    {
        public FrmGenerarRemito()
        {
            InitializeComponent();
            ConfigurarComboBoxes();
            MostrarFechaActual();
        }

        /// <summary>
        /// Configura los ComboBoxes con las opciones disponibles.
        /// </summary>
        private void ConfigurarComboBoxes()
        {
            // Configurar ComboBox de Tipo de Residuo
            cmbTipoResiduo.Items.Add("Aceite");
            cmbTipoResiduo.Items.Add("Grasa");
            cmbTipoResiduo.DropDownStyle = ComboBoxStyle.DropDownList;

            // Configurar ComboBox de Estado
            cmbEstado.Items.Add("Líquido");
            cmbEstado.Items.Add("Sólido");
            cmbEstado.DropDownStyle = ComboBoxStyle.DropDownList;
        }

        /// <summary>
        /// Muestra la fecha actual en el formato DD/MM/AAAA.
        /// </summary>
        private void MostrarFechaActual()
        {
            lblFechaEntrega.Text = $"Fecha de Entrega: {DateTime.Now.ToString("dd/MM/yyyy")}";
        }

        /// <summary>
        /// Maneja el cambio de selección en el ComboBox de Tipo de Residuo.
        /// Establece automáticamente el estado según el tipo seleccionado.
        /// </summary>
        private void cmbTipoResiduo_SelectedIndexChanged(object sender, EventArgs e)
        {
            // Establecer el estado por defecto según el tipo de residuo
            if (cmbTipoResiduo.SelectedItem != null)
            {
                if (cmbTipoResiduo.SelectedItem.ToString() == "Aceite")
                {
                    cmbEstado.SelectedItem = "Líquido";
                }
                else if (cmbTipoResiduo.SelectedItem.ToString() == "Grasa")
                {
                    cmbEstado.SelectedItem = "Sólido";
                }
            }
        }

        /// <summary>
        /// Maneja el evento de clic del botón Generar Remito.
        /// Valida los datos ingresados y genera el remito en la base de datos.
        /// </summary>
        private void btnGenerarRemito_Click(object sender, EventArgs e)
        {
            try
            {
                // Validar que todos los campos estén completos
                if (string.IsNullOrWhiteSpace(txtNombreGenerador.Text))
                {
                    MessageBox.Show("Debe ingresar el nombre del generador.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    txtNombreGenerador.Focus();
                    return;
                }

                if (string.IsNullOrWhiteSpace(txtDomicilioPlanta.Text))
                {
                    MessageBox.Show("Debe ingresar el domicilio de la planta.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    txtDomicilioPlanta.Focus();
                    return;
                }

                if (cmbTipoResiduo.SelectedItem == null)
                {
                    MessageBox.Show("Debe seleccionar el tipo de residuo.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    cmbTipoResiduo.Focus();
                    return;
                }

                if (string.IsNullOrWhiteSpace(txtCantidad.Text))
                {
                    MessageBox.Show("Debe ingresar la cantidad.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    txtCantidad.Focus();
                    return;
                }

                // Validar que la cantidad sea un número válido
                if (!decimal.TryParse(txtCantidad.Text, out decimal cantidad) || cantidad <= 0)
                {
                    MessageBox.Show("La cantidad debe ser un número válido mayor a 0.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    txtCantidad.Focus();
                    return;
                }

                if (cmbEstado.SelectedItem == null)
                {
                    MessageBox.Show("Debe seleccionar el estado.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    cmbEstado.Focus();
                    return;
                }

                if (string.IsNullOrWhiteSpace(txtCuit.Text))
                {
                    MessageBox.Show("Debe ingresar el CUIT.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    txtCuit.Focus();
                    return;
                }

                if (string.IsNullOrWhiteSpace(txtNombreFantasia.Text))
                {
                    MessageBox.Show("Debe ingresar el nombre de fantasía.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    txtNombreFantasia.Focus();
                    return;
                }

                if (string.IsNullOrWhiteSpace(txtDireccion.Text))
                {
                    MessageBox.Show("Debe ingresar la dirección.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    txtDireccion.Focus();
                    return;
                }

                // Si todas las validaciones pasan, proceder a generar el remito
                // Llamar al servicio de fachada RemitoService para generar el remito
                Guid idRemito = RemitoService.GenerarRemito(
                    txtNombreGenerador.Text.Trim(),
                    txtDomicilioPlanta.Text.Trim(),
                    cmbTipoResiduo.SelectedItem.ToString(),
                    cantidad,
                    cmbEstado.SelectedItem.ToString(),
                    txtCuit.Text.Trim(),
                    txtNombreFantasia.Text.Trim(),
                    txtDireccion.Text.Trim()
                );

                // Registrar el evento en el log
                LoggerService.WriteLog($"Se generó el remito con ID: {idRemito} para el generador {txtNombreGenerador.Text}.", 
                    System.Diagnostics.TraceLevel.Info);

                MessageBox.Show($"Remito generado exitosamente.\nID del Remito: {idRemito}", "Éxito", MessageBoxButtons.OK, MessageBoxIcon.Information);
                
                // Limpiar los campos después de generar el remito
                LimpiarFormulario();
            }
            catch (Exception ex)
            {
                // Registrar el error en el log
                MessageBox.Show($"Ocurrió un error al generar el remito: {ex.Message}", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                LoggerService.WriteException(ex);
            }
        }

        /// <summary>
        /// Limpia todos los campos del formulario.
        /// </summary>
        private void LimpiarFormulario()
        {
            txtNombreGenerador.Clear();
            txtDomicilioPlanta.Clear();
            cmbTipoResiduo.SelectedIndex = -1;
            txtCantidad.Clear();
            cmbEstado.SelectedIndex = -1;
            txtCuit.Clear();
            txtNombreFantasia.Clear();
            txtDireccion.Clear();
            
            // Actualizar la fecha después de limpiar
            MostrarFechaActual();
        }

        /// <summary>
        /// Maneja el evento de clic del botón Cancelar.
        /// Cierra el formulario sin guardar cambios.
        /// </summary>
        private void btnCancelar_Click(object sender, EventArgs e)
        {
            this.Close();
        }
    }
}
